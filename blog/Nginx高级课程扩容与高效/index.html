<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Nginx高级篇扩容与高效 | HahHome</title><meta name="author" content="spongehah"><meta name="copyright" content="spongehah"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nginx高级 第一部分：扩容通过扩容提升整体吞吐量 1.单机垂直扩容：硬件资源增加12345678910云服务资源增加整机：IBM、浪潮、DELL、HP等CPU&#x2F;主板：更新到主流网卡：10G&#x2F;40G网卡磁盘：SAS(SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、 MVMe SSDSSD多副本机制系统盘&#x2F;热点数据&#x2F;数据库存储HDD冷数据存储    2.水平扩展："><meta property="og:type" content="article"><meta property="og:title" content="Nginx高级篇扩容与高效"><meta property="og:url" content="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/index.html"><meta property="og:site_name" content="HahHome"><meta property="og:description" content="Nginx高级 第一部分：扩容通过扩容提升整体吞吐量 1.单机垂直扩容：硬件资源增加12345678910云服务资源增加整机：IBM、浪潮、DELL、HP等CPU&#x2F;主板：更新到主流网卡：10G&#x2F;40G网卡磁盘：SAS(SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、 MVMe SSDSSD多副本机制系统盘&#x2F;热点数据&#x2F;数据库存储HDD冷数据存储    2.水平扩展："><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.hahhome.top/img/cover_default_img/06.webp"><meta property="article:published_time" content="2023-10-01T06:41:00.000Z"><meta property="article:modified_time" content="2023-10-02T13:25:51.307Z"><meta property="article:author" content="spongehah"><meta property="article:tag" content="Nginx"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.hahhome.top/img/cover_default_img/06.webp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Nginx高级篇扩容与高效",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-10-02 21:25:51"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="https://npm.elemecdn.com/ethan4116-blog/lib/css/plane_v2.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/rightMenu.css"><link rel="stylesheet" href="/css/iconfont.css"><meta name="baidu-site-verification" content="codeva-yFYMl1Bz4G"><div id="myscoll"></div><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})</script><link rel="stylesheet" href="/css/loading-bar.css"><script src="/pluginsSrc/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.webp" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/cover_default_img/06.webp)"><nav id="nav"><span id="blog-info"><a href="/" title="HahHome"><span class="site-name">HahHome</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Nginx高级篇扩容与高效</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-01T06:41:00.000Z" title="发表于 2023-10-01 14:41:00">2023-10-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-02T13:25:51.307Z" title="更新于 2023-10-02 21:25:51">2023-10-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>86分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="Nginx高级篇扩容与高效"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Nginx高级-第一部分：扩容"><a href="#Nginx高级-第一部分：扩容" class="headerlink" title="Nginx高级 第一部分：扩容"></a>Nginx高级 第一部分：扩容</h1><p>通过扩容提升整体吞吐量</p><h2 id="1-单机垂直扩容：硬件资源增加"><a href="#1-单机垂直扩容：硬件资源增加" class="headerlink" title="1.单机垂直扩容：硬件资源增加"></a>1.单机垂直扩容：硬件资源增加</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">云服务资源增加</span><br><span class="line">整机：IBM、浪潮、DELL、HP等</span><br><span class="line">CPU/主板：更新到主流</span><br><span class="line">网卡：10G/40G网卡</span><br><span class="line">磁盘：SAS(SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、 MVMe SSD</span><br><span class="line">SSD</span><br><span class="line">多副本机制</span><br><span class="line">系统盘/热点数据/数据库存储</span><br><span class="line">HDD</span><br><span class="line">冷数据存储</span><br></pre></td></tr></table></figure><h2 id="2-水平扩展：集群化"><a href="#2-水平扩展：集群化" class="headerlink" title="2.水平扩展：集群化"></a>2.水平扩展：集群化</h2><h2 id="基本调优"><a href="#基本调优" class="headerlink" title="基本调优"></a>基本调优</h2><h3 id="会话管理-修改负载均衡策略"><a href="#会话管理-修改负载均衡策略" class="headerlink" title="会话管理-修改负载均衡策略"></a>会话管理-修改负载均衡策略</h3><h4 id="Nginx高级负载均衡"><a href="#Nginx高级负载均衡" class="headerlink" title="Nginx高级负载均衡"></a>Nginx高级负载均衡</h4><p><strong>ip_hash</strong></p><ul><li>会导致流量倾斜，ip集中</li><li>若后端服务器宕机，对应ip的服务将无法提供</li><li>应用场景：中小型项目快速扩容时，不想修改代码，只需增加几台服务器使用ip_hash就可临时实现</li></ul><p><strong>hash $cookie_jsessionid;</strong></p><ul><li>根据cookie中的jsessionid的不同转发到对应的服务器</li></ul><p><strong>hash $request_uri;</strong></p><ul><li>根据uri的不同转发到对应的服务器</li></ul><p><strong>使用lua逻辑定向分发</strong></p><p><strong>Redis + SpringSession</strong></p><ul><li>要修改代码</li><li>所有前端服务器的请求打在redis服务器上，redis受不了</li></ul><p>ip_hash示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds &#123;</span><br><span class="line">ip_hash;			<span class="comment">#设置负载均衡策略为ip_hash</span></span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.44.102</span> ;</span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.44.103</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">     <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">     <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">     <span class="section">location</span> / &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line"></span><br><span class="line">   	<span class="comment"># root   html;</span></span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="section">location</span> ~*/(css|img|js) &#123;</span><br><span class="line">  </span><br><span class="line">     <span class="attribute">root</span>   /usr/local/nginx/html;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h4 id="使用sticky模块完成对Nginx的负载均衡"><a href="#使用sticky模块完成对Nginx的负载均衡" class="headerlink" title="使用sticky模块完成对Nginx的负载均衡"></a>使用sticky模块完成对Nginx的负载均衡</h4><p><strong>使用参考</strong></p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#sticky">http://nginx.org/en/docs/http/ngx_http_upstream_module.html#sticky</a></p><p>tengine中有session_sticky模块我们通过第三方的方式安装在开源版本中</p><p>sticky是第三方模块，需要重新编译Nginx,他可以对Nginx这种静态文件服务器使用基于cookie的负载均衡</p><p><strong>1.下载模块</strong></p><p><strong>项目官网</strong></p><p><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/</a></p><p>另外一个版本</p><p><a target="_blank" rel="noopener" href="https://github.com/bymaximus/nginx-sticky-module-ng">https://github.com/bymaximus/nginx-sticky-module-ng</a></p><p><strong>下载</strong></p><p><a target="_blank" rel="noopener" href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/1.2.6.zip">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/1.2.6.zip</a></p><p><strong>2.上传解压</strong></p><p><strong>3.重新编译Nginx</strong></p><p><strong>进到源码目录重新编译</strong></p><p><font color="cornflowerblue">configure时记得加上自己原本有的后缀</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/nginx-1.21.6	#根据自己的实际目录</span><br><span class="line">./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br></pre></td></tr></table></figure><p><strong>执行make</strong></p><p><strong>make时如遇报错修改源码</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624154939957.webp" alt="image-20230624154939957"></p><p>打开sticky文件夹中 <code>ngx_http_sticky_misc.c</code>文件</p><p>在12行添加</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/md5.h&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>若缺少依赖<code>openssl-devel</code></strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum intall -y openssl-devel</span><br></pre></td></tr></table></figure><p><strong>备份之前的程序</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br></pre></td></tr></table></figure><p><strong>把编译好的Nginx程序替换到原来的目录里</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure><p><strong>升级检测</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure><p>检查程序中是否包含新模块</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure><p>配置示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> httpget &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">sticky</span> name=route expires=<span class="number">6h</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.44.102</span>;</span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.44.103</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求头中的cookie中带有key为route的数据，重复请求该值不变，route是由sticky模块下发的值</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624160320269.webp" alt="image-20230624160320269"></p><h3 id="KeepAlive"><a href="#KeepAlive" class="headerlink" title="KeepAlive"></a>KeepAlive</h3><p>不是keepalived 没有d</p><p><strong>KeepAlive：保持长连接，避免过多的http连接的建立</strong>，在http协议header中可以看到当前KeepAlive的连接状态</p><p><strong>可使用测试工具charles</strong>，也可以直接使用浏览器开发者模式，不过可能因为缓存原因刷新失败</p><p>类似于wireshark，一个抓包工具</p><p><strong>下载地址</strong></p><p><a target="_blank" rel="noopener" href="https://www.charlesproxy.com/assets/release/4.6.2/charles-proxy-4.6.2-win64.msi?k=fc1457e312">https://www.charlesproxy.com/assets/release/4.6.2/charles-proxy-4.6.2-win64.msi?k=fc1457e312</a></p><p><strong>官网</strong></p><p><a target="_blank" rel="noopener" href="https://www.charlesproxy.com/">https://www.charlesproxy.com</a></p><h4 id="什么时候用和不用？"><a href="#什么时候用和不用？" class="headerlink" title="什么时候用和不用？"></a>什么时候用和不用？</h4><p><strong>用？</strong></p><p>明显的预知用户会在当前连接上有下一步操作</p><p>复用连接，有效减少握手次数，尤其是https建立一次连接开销会更大</p><p><strong>不用？</strong></p><p>访问内联资源一般用缓存，不需要keepalive</p><p>长时间的tcp连接容易导致系统资源无效占用</p><h4 id="对客户端使用keepalive"><a href="#对客户端使用keepalive" class="headerlink" title="&#x3D;&#x3D;对客户端使用keepalive&#x3D;&#x3D;"></a>&#x3D;&#x3D;<font color="red">对客户端使用keepalive</font>&#x3D;&#x3D;</h4><p>客户端一般是浏览器</p><p><font color="cornflowerblue">配置位置：http</font></p><ul><li><strong>keepalive_timeout</strong></li></ul><p>nginx.conf配置文件中修改keepalive_timeout，默认是65（s），修改成0即为关闭</p><p>用于设置Nginx服务器与客户端保持连接的超时时间</p><p>用于踢出不活动连接</p><p>keepalive_timeout &#x3D; 0 即关闭</p><p>可以设置两个参数， keepalive_timeout 65 65;</p><p>第二个参数用于配置http1.0版本，1.1不需要</p><ul><li><strong>keepalive_disable</strong></li></ul><p>不对某些浏览器建立长连接</p><p>默认msie6</p><ul><li><strong>keepalive_time</strong></li></ul><p>限制keepalive保持连接的最大时间，超过之后 强制失效</p><p>默认是1h</p><p>1.19.10新功能</p><ul><li><strong>keepalive_request</strong></li></ul><p>默认1000，1000已经够用</p><p>一个tcp复用中 可以并发接收的请求个数</p><ul><li><strong>send_timeout</strong></li></ul><p>两次向客户端写操作之间的间隔 如果大于这个时间则关闭连接 默认60s</p><p>send_timeout 10; 10秒</p><p>send_timeout 10 10; 同时下发一个header 告诉浏览器</p><p><strong>此处有坑</strong>，注意耗时的同步操作有可能会丢弃用户连接</p><p>该设置表示Nginx服务器与客户端连接后，某次会话中服务器等待客户端响应超过10s，就会自动关闭连接。</p><p>配置示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span> <span class="number">65</span>; <span class="comment">#超过这个时间 没有活动，会让keepalive失效 ，第二个参数用于配置http1.0版本，1.1不需要</span></span><br><span class="line">    <span class="attribute">keepalive_time</span> <span class="number">1h</span>; <span class="comment"># 一个tcp连接总时长，超过之后 强制失效</span></span><br><span class="line">  </span><br><span class="line">    <span class="attribute">send_timeout</span> <span class="number">60</span>;<span class="comment"># 默认60s  此处有坑！！ 系统中 若有耗时操作，超过 send_timeout 强制断开连接。 注意：准备过程中，不是传输过程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">1000</span>;  <span class="comment">#一个tcp复用中 可以并发接收的请求个数</span></span><br></pre></td></tr></table></figure><h4 id="对上游服务器使用keepalive"><a href="#对上游服务器使用keepalive" class="headerlink" title="&#x3D;&#x3D;对上游服务器使用keepalive&#x3D;&#x3D;"></a>&#x3D;&#x3D;<font color="red">对上游服务器使用keepalive</font>&#x3D;&#x3D;</h4><p>上游服务器就是后端服务器</p><p>首先需要配置使用http1.1协议。以便建立更高效的传输，默认使用http1.0，在http1.0中需要配置header才能</p><p>在Upstream中所配置的上游服务器默认都是用短连接，即每次请求都会在完成之后断开</p><p><strong>upstream中配置</strong></p><p>配置</p><ul><li><strong>keepalive 100;</strong></li></ul><p>向上游服务器的保留连接数</p><ul><li><strong>keepalive_timeout 65</strong></li></ul><p>连接保留时间</p><ul><li><strong>keepalive_requests 1000</strong></li></ul><p>一个tcp复用中 可以并发接收的请求个数</p><p><strong>server中的location配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"><span class="comment">#配置http版本号</span></span><br><span class="line"><span class="comment">#因为nginx默认使用http1.0协议，需要在request中增加”Connection： keep-alive“ header才能够支持，而HTTP1.1默认支持。</span></span><br><span class="line"><span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;			<span class="comment">#清除close信息</span></span><br></pre></td></tr></table></figure><p><font color="cornflowerblue">由于nginx默认为 http 1.0 ，不支持服务端长连接，请求头会携带 connection： close ，所以需要指定http版本为 http 1.1，同时设置connection： “”</font></p><p>配置示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">#定义集群</span></span><br><span class="line">   <span class="section">upstream</span> cluster &#123;</span><br><span class="line"><span class="attribute">keepalive</span> <span class="number">100</span>;</span><br><span class="line"><span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"><span class="attribute">keepalive_requests</span> <span class="number">1000</span>;</span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.111.101:80</span>;</span><br><span class="line"><span class="attribute">server</span> <span class="number">192.168.111.102:80</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">           <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">#反向代理到集群，配置负载均衡</span></span><br><span class="line">           <span class="attribute">proxy_pass</span> http://cluster;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><h4 id="KeepAlive配置总结"><a href="#KeepAlive配置总结" class="headerlink" title="KeepAlive配置总结"></a>KeepAlive配置总结</h4><p>一般情况下：</p><ul><li>对客户端使用keepAlive全部配上，使用默认值</li><li>对上游服务器使用keepAlive全部配上，使用默认值</li></ul><h4 id="KeepAlive压测：AB安装使用"><a href="#KeepAlive压测：AB安装使用" class="headerlink" title="KeepAlive压测：AB安装使用"></a>KeepAlive压测：AB安装使用</h4><p>apache benchmark：一款压力测试插件，直接通过yum安装即可</p><p>yum install httpd-tools</p><p>参数说明：</p><ul><li><strong>-n 即requests，用于指定压力测试总共的执行次数。</strong></li><li><strong>-c 即concurrency，用于指定的并发数。</strong></li><li>-t 即timelimit，等待响应的最大时间(单位：秒)。</li><li>-b 即windowsize，TCP发送&#x2F;接收的缓冲大小(单位：字节)。</li><li>-p 即postfile，发送POST请求时需要上传的文件，此外还必须设置-T参数。</li><li>-u 即putfile，发送PUT请求时需要上传的文件，此外还必须设置-T参数。</li><li>-T 即content-type，用于设置Content-Type请求头信息，例如：application&#x2F;x-www-form-urlencoded，默认值为text&#x2F;plain。</li><li>-v 即verbosity，指定打印帮助信息的冗余级别。</li><li>-w 以HTML表格形式打印结果。</li><li>-i 使用HEAD请求代替GET请求。</li><li>-x 插入字符串作为table标签的属性。</li><li>-y 插入字符串作为tr标签的属性。</li><li>-z 插入字符串作为td标签的属性。</li><li>-C 添加cookie信息，例如：”Apache&#x3D;1234”(可以重复该参数选项以添加多个)。</li><li>-H 添加任意的请求头，例如：”Accept-Encoding: gzip”，请求头将会添加在现有的多个请求头之后(可以重复该参数选项以添加多个)。</li><li>-A 添加一个基本的网络认证信息，用户名和密码之间用英文冒号隔开。</li><li>-P 添加一个基本的代理认证信息，用户名和密码之间用英文冒号隔开。</li><li>-X 指定使用的和端口号，例如:”126.10.10.3:88”。</li><li>-V 打印版本号并退出。</li><li>-k 使用HTTP的KeepAlive特性。</li><li>-d 不显示百分比。</li><li>-S 不显示预估和警告信息。</li><li>-g 输出结果信息到gnuplot格式的文件中。</li><li>-e 输出结果信息到CSV格式的文件中。</li><li>-r 指定接收到错误信息时不退出程序。</li><li>-h 显示用法信息，其实就是ab -help。</li></ul><p>压测语句：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 100000 c 30 http://192.168.111.102/</span><br></pre></td></tr></table></figure><p><strong>直连nginx</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.44.102</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        16 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   13.035 seconds</span><br><span class="line">Complete requests:      100000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      25700000 bytes</span><br><span class="line">HTML transferred:       1600000 bytes</span><br><span class="line">Requests per second:    7671.48 [#/sec] (mean)</span><br><span class="line">Time per request:       3.911 [ms] (mean)</span><br><span class="line">Time per request:       0.130 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1925.36 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.4      0      12</span><br><span class="line">Processing:     1    3   1.0      3      14</span><br><span class="line">Waiting:        0    3   0.9      3      14</span><br><span class="line">Total:          2    4   0.9      4      14</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      4</span><br><span class="line">  66%      4</span><br><span class="line">  75%      4</span><br><span class="line">  80%      4</span><br><span class="line">  90%      5</span><br><span class="line">  95%      5</span><br><span class="line">  98%      6</span><br><span class="line">  99%      7</span><br><span class="line"> 100%     14 (longest request)</span><br></pre></td></tr></table></figure><p><strong>反向代理</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.44.101</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        16 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   25.968 seconds</span><br><span class="line">Complete requests:      100000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      25700000 bytes</span><br><span class="line">HTML transferred:       1600000 bytes</span><br><span class="line">Requests per second:    3850.85 [#/sec] (mean)</span><br><span class="line">Time per request:       7.790 [ms] (mean)</span><br><span class="line">Time per request:       0.260 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          966.47 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.2      0      13</span><br><span class="line">Processing:     3    8   1.4      7      22</span><br><span class="line">Waiting:        1    7   1.4      7      22</span><br><span class="line">Total:          3    8   1.4      7      22</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      7</span><br><span class="line">  66%      8</span><br><span class="line">  75%      8</span><br><span class="line">  80%      8</span><br><span class="line">  90%      9</span><br><span class="line">  95%     10</span><br><span class="line">  98%     12</span><br><span class="line">  99%     13</span><br><span class="line"> 100%     22 (longest request)</span><br></pre></td></tr></table></figure><p><strong>直连Tomcat</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.44.105</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        7834 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   31.033 seconds</span><br><span class="line">Complete requests:      100000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      804300000 bytes</span><br><span class="line">HTML transferred:       783400000 bytes</span><br><span class="line">Requests per second:    3222.38 [#/sec] (mean)</span><br><span class="line">Time per request:       9.310 [ms] (mean)</span><br><span class="line">Time per request:       0.310 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          25310.16 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.3      0      15</span><br><span class="line">Processing:     0    9   7.8      7     209</span><br><span class="line">Waiting:        0    9   7.2      7     209</span><br><span class="line">Total:          0    9   7.8      7     209</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      7</span><br><span class="line">  66%      9</span><br><span class="line">  75%     11</span><br><span class="line">  80%     13</span><br><span class="line">  90%     18</span><br><span class="line">  95%     22</span><br><span class="line">  98%     27</span><br><span class="line">  99%     36</span><br><span class="line"> 100%    209 (longest request)</span><br></pre></td></tr></table></figure><p><strong>nginx反向代理Tomcat + keepalive</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.44.101</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        7834 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   23.379 seconds</span><br><span class="line">Complete requests:      100000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      806500000 bytes</span><br><span class="line">HTML transferred:       783400000 bytes</span><br><span class="line">Requests per second:    4277.41 [#/sec] (mean)</span><br><span class="line">Time per request:       7.014 [ms] (mean)</span><br><span class="line">Time per request:       0.234 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          33688.77 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.2      0       9</span><br><span class="line">Processing:     1    7   4.2      6     143</span><br><span class="line">Waiting:        1    7   4.2      6     143</span><br><span class="line">Total:          1    7   4.2      6     143</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      6</span><br><span class="line">  66%      7</span><br><span class="line">  75%      7</span><br><span class="line">  80%      7</span><br><span class="line">  90%      8</span><br><span class="line">  95%     10</span><br><span class="line">  98%     13</span><br><span class="line">  99%     16</span><br><span class="line"> 100%    143 (longest request)</span><br></pre></td></tr></table></figure><p><strong>nginx反向代理Tomcat</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.21.6</span><br><span class="line">Server Hostname:        192.168.44.101</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        7834 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      30</span><br><span class="line">Time taken for tests:   33.814 seconds</span><br><span class="line">Complete requests:      100000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      806500000 bytes</span><br><span class="line">HTML transferred:       783400000 bytes</span><br><span class="line">Requests per second:    2957.32 [#/sec] (mean)</span><br><span class="line">Time per request:       10.144 [ms] (mean)</span><br><span class="line">Time per request:       0.338 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          23291.74 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.2      0       9</span><br><span class="line">Processing:     1   10   5.5      9     229</span><br><span class="line">Waiting:        1   10   5.5      9     229</span><br><span class="line">Total:          1   10   5.5      9     229</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%      9</span><br><span class="line">  66%     10</span><br><span class="line">  75%     11</span><br><span class="line">  80%     11</span><br><span class="line">  90%     13</span><br><span class="line">  95%     14</span><br><span class="line">  98%     17</span><br><span class="line">  99%     19</span><br><span class="line"> 100%    229 (longest request)</span><br></pre></td></tr></table></figure><h3 id="UpStream-反向代理上游集群-工作流程"><a href="#UpStream-反向代理上游集群-工作流程" class="headerlink" title="UpStream(反向代理上游集群)工作流程"></a>UpStream(反向代理上游集群)工作流程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624174235190.webp" alt="image-20230624174235190"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624174246944.webp" alt="image-20230624174246944"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624174400920.webp" alt="image-20230624174400920"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230624174406412.webp" alt="image-20230624174406412"></p><p>proxy_pass 向上游服务器请求数据共有6个阶段</p><ul><li>初始化</li><li>与上游服务器建立连接</li><li>向上游服务器发送请求</li><li>处理响应头</li><li>处理响应体</li><li>结束</li></ul><h4 id="对客户端的限制配置"><a href="#对客户端的限制配置" class="headerlink" title="&#x3D;&#x3D;对客户端的限制配置&#x3D;&#x3D;"></a>&#x3D;&#x3D;<font color="red">对客户端的限制配置</font>&#x3D;&#x3D;</h4><p>可配置位置</p><ul><li><p><font color="cornflowerblue">http</font></p></li><li><p><font color="cornflowerblue">server</font></p></li><li><p><font color="cornflowerblue"><strong>location</strong></font></p></li><li><p><strong>client_body_buffer_size</strong></p></li></ul><p>对客户端请求中的body缓冲区大小</p><p>默认32位系统8k 64位16k</p><p>如果请求体大于配置，则写入临时文件</p><ul><li><strong>client_header_buffer_size</strong></li></ul><p>设置读取客户端请求体的缓冲区大小。 如果请求体大于缓冲区，则将整个请求体或仅将其部分写入临时文件。 默认32位8K。 64位平台16K。</p><ul><li><strong>client_max_body_size 1000M;</strong></li></ul><p>默认1m，如果一个请求的大小超过配置的值，会返回413 (request Entity Too Large)错误给客户端</p><p>将size设置为0将禁用对客户端请求正文大小的检查。</p><ul><li><strong>client_body_timeout</strong></li></ul><p>指定客户端与服务端建立连接后发送 request body 的超时时间。如果客户端在指定时间内没有发送任何内容，Nginx 返回 HTTP 408（Request Timed Out）</p><ul><li><strong>client_header_timeout</strong></li></ul><p>客户端向服务端发送一个完整的 request header 的超时时间。如果客户端在指定时间内没有发送一个完整的 request header，Nginx 返回 HTTP 408（Request Timed Out）。</p><ul><li><strong>client_body_temp_path</strong> <em>path</em><code>[</code><em>level1</em><code>[</code><em>level2</em><code>[</code><em>level3</em>&#96;]]]</li></ul><p>在磁盘上客户端的body临时缓冲区位置</p><p><strong>client_body_in_file_only on;</strong></p><p>把body写入磁盘文件，请求结束也不会删除</p><ul><li><strong>client_body_in_single_buffer</strong></li></ul><p>尽量缓冲body的时候在内存中使用连续单一缓冲区，在二次开发时使用<code>$request_body</code>读取数据时性能会有所提高</p><ul><li><strong>client_header_buffer_size</strong></li></ul><p>设置读取客户端请求头的缓冲区大小</p><p>如果一个请求行或者一个请求头字段不能放入这个缓冲区，那么就会使用large_client_header_buffers</p><ul><li><strong>large_client_header_buffers</strong></li></ul><p>默认8k</p><h4 id="header和连接配置"><a href="#header和连接配置" class="headerlink" title="&#x3D;&#x3D;header和连接配置&#x3D;&#x3D;"></a>&#x3D;&#x3D;<font color="red">header和连接配置</font>&#x3D;&#x3D;</h4><p><font color="cornflowerblue">配置位置：推荐location</font></p><ul><li><strong>add_header | proxy_set_header</strong></li></ul><p>设置header</p><ul><li><strong>proxy_connect_timeout</strong></li></ul><p>与上游服务器连接超时时间、快速失败</p><ul><li><strong>proxy_send_timeout</strong></li></ul><p>定义nginx向后端服务发送请求的间隔时间(不是耗时)。默认60秒，超过这个时间会关闭连接</p><ul><li><strong>proxy_read_timeout</strong></li></ul><p>后端服务给nginx响应的时间，规定时间内后端服务没有给nginx响应，连接会被关闭，nginx返回504 Gateway Time-out。默认60秒</p><h4 id="缓冲区配置"><a href="#缓冲区配置" class="headerlink" title="&#x3D;&#x3D;缓冲区配置&#x3D;&#x3D;"></a>&#x3D;&#x3D;<font color="red">缓冲区配置</font>&#x3D;&#x3D;</h4><p><font color="cornflowerblue">配置位置：推荐location</font></p><ul><li><strong>proxy_requset_buffering</strong></li></ul><p>是否完全读到请求体之后再向上游服务器发送请求</p><ul><li><strong>proxy_buffering</strong></li></ul><p>是否缓冲上游服务器数据</p><ul><li><strong>proxy_buffers 32 64k;</strong></li></ul><p>缓冲区大小 32个 64k大小内存缓冲块</p><ul><li><strong>proxy_buffer_size</strong></li></ul><p>header缓冲区大小</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_requset_buffering</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">proxy_buffers</span> <span class="number">32</span> <span class="number">128k</span>;</span><br><span class="line"><span class="attribute">proxy_busy_buffers_size</span> <span class="number">8k</span>;</span><br><span class="line"><span class="attribute">proxy_max_temp_file_size</span> <span class="number">1024m</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>proxy_temp_file_write_size 8k</strong></li></ul><p>当启用从代理服务器到临时文件的响应的缓冲时，一次限制写入临时文件的数据的大小。 默认情况下，大小由proxy_buffer_size和proxy_buffers指令设置的两个缓冲区限制。 临时文件的最大大小由proxy_max_temp_file_size指令设置。</p><ul><li><strong>proxy_max_temp_file_size 1024m;</strong></li></ul><p>临时文件最大值</p><ul><li><strong>proxy_temp_path</strong></li></ul><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_temp_path /spool/nginx/proxy_temp 1 2;</span><br></pre></td></tr></table></figure></blockquote><p>a temporary file might look like this:</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/spool/nginx/proxy_temp/7/45/00000123457</span><br></pre></td></tr></table></figure></blockquote><h4 id="UpStream配置总结"><a href="#UpStream配置总结" class="headerlink" title="UpStream配置总结"></a>UpStream配置总结</h4><p>自己的阿里云服务器配置示例：</p><p>需要配置下列一项才能完成登录等post请求，否侧会返回500<br>proxy_set_header Host $host;</p><p>注释掉的都可以配一配，参考的别人的</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">#反向代理到集群，配置负载均衡</span></span><br><span class="line">          <span class="attribute">proxy_pass</span> http://47.115.207.49:8099/;</span><br><span class="line">  		<span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">#proxy_redirect off;</span></span><br><span class="line">          <span class="comment">#proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">          <span class="comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;           </span></span><br><span class="line">          <span class="comment">#proxy_set_header Cookie $http_cookie;</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">#proxy_send_timeout 1300;</span></span><br><span class="line">          <span class="comment">#proxy_read_timeout 1300;</span></span><br><span class="line">          <span class="comment">#proxy_buffer_size 64k;</span></span><br><span class="line">          <span class="comment">#proxy_buffers 8 64k;</span></span><br><span class="line">          <span class="comment">#proxy_busy_buffers_size 128k;</span></span><br><span class="line">          <span class="comment">#proxy_temp_file_write_size 64k;</span></span><br><span class="line">          <span class="comment">#client_max_body_size 10m;</span></span><br><span class="line">          <span class="comment">#client_body_buffer_size 128k;</span></span><br><span class="line">          <span class="comment">#proxy_connect_timeout 1300;</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">#root   /www/www;</span></span><br><span class="line">          <span class="comment">#index  index.html index.htm;</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><h4 id="获取客户端真实IP"><a href="#获取客户端真实IP" class="headerlink" title="获取客户端真实IP"></a>获取客户端真实IP</h4><p>用到header设置：	proxy_set_header</p><p><strong>X-Real-IP</strong></p><p>额外模块，不推荐使用</p><p><strong>X-Forwarded-For</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header X-Forwarded-For $remote_addr;</span><br></pre></td></tr></table></figure><p>$remote_addr	：	前置ip地址，这里是获取nginx服务器的前置ip，那就是客户端ip</p><p>若有两层nginx服务器，一种方法是转发第一层nginx发过来的remote_addr，另一种方法是不覆盖再加一个header记录第二层nginx的remote_addr</p><h3 id="Gzip"><a href="#Gzip" class="headerlink" title="Gzip"></a>Gzip</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230627140313937.webp" alt="image-20230627140313937"></p><p>适合静态资源，但是</p><p><strong>二进制资源</strong>：例如图片&#x2F;mp3这样的二进制文件,不必压缩；因为压缩率比较小, 比如100-&gt;80字节,而且压缩也是耗费CPU资源的.</p><h4 id="Gzip动态压缩配置"><a href="#Gzip动态压缩配置" class="headerlink" title="Gzip动态压缩配置"></a>Gzip动态压缩配置</h4><p>作用域 <code>http, server, location</code></p><ul><li><strong>gzip on;</strong></li></ul><p>开关，默认关闭</p><ul><li><strong>gzip_buffers 32 4k|16 8k</strong></li></ul><p>缓冲区大小</p><p>32位cpu推荐选 32 4k</p><p>64位cpu推荐选 16 8k</p><ul><li><strong>gzip_comp_level 1；</strong></li></ul><p>压缩等级 1-9，数字越大压缩比越高</p><p>推荐1-6</p><ul><li><strong>gzip_http_version 1.1;</strong></li></ul><p>使用gzip的最小版本</p><ul><li><strong>gzip_min_length</strong></li></ul><p>设置将被gzip压缩的响应的最小长度。 长度仅由“Content-Length”响应报头字段确定。</p><p>大于这个设置长度才会压缩数据，否则不压缩</p><p>一般1k~5K</p><ul><li><strong>gzip_proxied 多选</strong></li></ul><p>off 为不做限制</p><p>作为反向代理时，针对上游服务器返回的头信息进行压缩</p><p>expired - 启用压缩，如果header头中包含 “Expires” 头信息<br>no-cache - 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息<br>no-store - 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息<br>private - 启用压缩，如果header头中包含 “Cache-Control:private” 头信息<br>no_last_modified - 启用压缩,如果header头中不包含 “Last-Modified” 头信息<br>no_etag - 启用压缩 ,如果header头中不包含 “ETag” 头信息<br>auth - 启用压缩 , 如果header头中包含 “Authorization” 头信息<br>any - 无条件启用压缩</p><ul><li><strong>gzip_vary on;</strong></li></ul><p>增加一个header，适配老的浏览器 <code>Vary: Accept-Encoding</code></p><ul><li><strong>gzip_types</strong></li></ul><p>哪些mime类型的文件进行压缩</p><ul><li><strong>gzip_disable</strong></li></ul><p>禁止某些浏览器使用gzip</p><p>会使用正则表达式，<font color="red">一般不推荐配置文件使用正则表达式，会额外消耗服务器的性能</font></p><p><strong>完整实例</strong></p><p><font color="cornflowerblue">加载location或者server中</font></p><p><font color="cornflowerblue">使用Gzip动态压缩会导致sendFile功能无法使用，于是使用静态压缩来解决这个问题，静态压缩只用给nginx加装module即可，配置加一行gzip_static on; 前提：服务器硬盘指定静态资源的位置，已经有压缩好的文件.gz</font></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">256</span>;</span><br><span class="line"><span class="attribute">gzip_proxied</span> any;</span><br><span class="line"><span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_types</span> text/plain application/x-javascript text/css application/xml;</span><br><span class="line"><span class="attribute">gzip_types</span></span><br><span class="line">  text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">  text/javascript application/javascript application/x-javascript</span><br><span class="line">  text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">  text/css text/plain text/x-component</span><br><span class="line">  font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">  image/x-icon;</span><br><span class="line"><span class="comment">#gzip_disable &quot;MSIE [1-6]\.(?!.*SV1)&quot;;	#正则会消耗服务器性能，不推荐配置</span></span><br></pre></td></tr></table></figure><p>未配置gzip的响应报文</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.21.6</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Wed, 18 May 2022 17:42:35 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html;charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>7832</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Keep-Alive</span><span class="punctuation">: </span>timeout=65</span><br></pre></td></tr></table></figure><p>配置gzip的响应报文</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.21.6</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Wed, 18 May 2022 17:42:35 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html;charset=utf-8</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Keep-Alive</span><span class="punctuation">: </span>timeout=65</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Encoding</span><span class="punctuation">: </span>gzip</span><br></pre></td></tr></table></figure><h4 id="Gzip静态压缩"><a href="#Gzip静态压缩" class="headerlink" title="Gzip静态压缩"></a>Gzip静态压缩</h4><p><strong>http_gzip_static_module</strong></p><p><font color="cornflowerblue">前提：服务器硬盘指定静态资源的位置，已经有压缩好的文件.gz</font></p><p>需要重新编译nginx</p><p><font color="cornflowerblue">configure时记得加上自己原本有的后缀</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-http_gzip_static_module</span><br></pre></td></tr></table></figure><p>编译后make和复制启动命令，具体参考	使用sticky模块完成对Nginx的负载均衡 部分</p><p>配置：在动态压缩的基础上加上gzip_static on;</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br></pre></td></tr></table></figure><p><strong>ngx_http_gunzip_module</strong></p><p>不常用</p><p>作用：将压缩包发送给客户端前，帮助先解压再给客户端</p><p>帮助不支持gzip的客户端解压本地文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-http_gunzip_module</span><br></pre></td></tr></table></figure><p>配置：在前面的配置基础上加上gunzip on;并修改为gzip_static always;</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gunzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_static</span> always;</span><br></pre></td></tr></table></figure><h3 id="Brotli（Br）"><a href="#Brotli（Br）" class="headerlink" title="Brotli（Br）"></a>Brotli（Br）</h3><p>Brotli为比Gzip压缩比更高的压缩方式，需要加载新的nginx模块才能实现</p><p>可以和Gzip共存，若客户端不支持Brotli则使用Gzip</p><p><strong>安装模块</strong></p><ul><li><p>官网</p><ul><li><p><code>https://github.com/google/ngx_brotli</code></p></li><li><p><code>https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9</code></p></li></ul></li><li><p>下载 两个项目</p></li><li><p>解压缩</p></li><li><p>将brotli-1.0.9目录下的所有东西移动到ngx_brotli-1.0.0rc&#x2F;deps&#x2F;brotli&#x2F;下</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/brotli-1.0.9/</span><br><span class="line">mv ./* /root/ngx_brotli-1.0.0rc/deps/brotli/</span><br></pre></td></tr></table></figure><p>模块化编译</p><p><font color="cornflowerblue">configure时记得加上自己原本有的后缀</font></p><p>–add-dynamic-module：动态编译，临时存在于nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--add-dynamic-module=brotli目录</span><br></pre></td></tr></table></figure><ul><li>make</li><li>将objs中的<code>ngx_http_brotli_filter_module.so</code> <code>ngx_http_brotli_static_module.so</code>拷贝到<code>/usr/local/nginx/modules/</code></li><li>备份然后复制nginx主程序</li></ul><p><strong>配置文件中添加</strong></p><p>在最外层加，例如配置文件最前面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;;</span><br><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;;</span><br></pre></td></tr></table></figure><p><font color="cornflowerblue">location或server加（和Gzip一起）</font></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">brotli</span> <span class="literal">on</span>;</span><br><span class="line">   <span class="attribute">brotli_static</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">brotli_comp_level</span> <span class="number">6</span>;</span><br><span class="line"><span class="attribute">brotli_buffers</span> <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line"><span class="attribute">brotli_min_length</span> <span class="number">20</span>;</span><br><span class="line"><span class="attribute">brotli_types</span> text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>测试</li></ul><p>默认http协议是没有br的，即http请求头中没有带br的请求方式，需要使用curl自己指定header</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;Accept-Encoding: br&#x27; -I http://192.168.111.100</span><br></pre></td></tr></table></figure><h3 id="反向代理中的容错机制"><a href="#反向代理中的容错机制" class="headerlink" title="反向代理中的容错机制"></a>反向代理中的容错机制</h3><h4 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h4><p><a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/">https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/</a></p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_bind">http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_bind</a></p><p><strong>proxy_timeout</strong></p><h4 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h4><p><strong>proxy_next_upstream</strong></p><p>作用：</p><p>当后端服务器返回指定的错误时，将请求传递到其他服务器。</p><p><code>error</code>与服务器建立连接，向其传递请求或读取响应头时发生错误;</p><p><code>timeout</code>在与服务器建立连接，向其传递请求或读取响应头时发生超时;</p><p><code>invalid_header</code>服务器返回空的或无效的响应;</p><p><code>http_500</code>服务器返回代码为500的响应;</p><p><code>http_502</code>服务器返回代码为502的响应;</p><p><code>http_503</code>服务器返回代码为503的响应;</p><p><code>http_504</code>服务器返回代码504的响应;</p><p><code>http_403</code>服务器返回代码为403的响应;</p><p><code>http_404</code>服务器返回代码为404的响应;</p><p><code>http_429</code>服务器返回代码为429的响应;</p><p>不了解这个机制，在日常开发web服务的时候，就可能会踩坑。</p><p>比如有这么一个场景：一个用于导入数据的web页面，上传一个excel，通过读取、处理excel，向数据库中插入数据，处理时间较长（如1分钟），且为同步操作（即处理完成后才返回结果）。暂且不论这种方式的好坏，若nginx配置的响应等待时间（proxy_read_timeout）为30秒，就会触发超时重试，将请求又打到另一台。如果处理中没有考虑到重复数据的场景，就会发生数据多次重复插入！（当然，这种场景，内网可以通过机器名访问该服务器进行操作，就可以绕过nginx了，不过外网就没办法了。）</p><h2 id="并发调优"><a href="#并发调优" class="headerlink" title="并发调优"></a>并发调优</h2><h3 id="Concat合并客户端请求"><a href="#Concat合并客户端请求" class="headerlink" title="Concat合并客户端请求"></a>Concat合并客户端请求</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230627143528769.webp" alt="image-20230627143528769"></p><p>将文本类的请求合并起来成一个请求（需要修改代码），再发给客户端，<font color="cornflowerblue">能够减少并发请求，让并发量变小</font>提高能处理的并发数</p><p>虽然多个类似于css文件会额外消耗服务器性能，但为了便于管理，也会分开来</p><p>Concat模块</p><p>Tengine</p><p>Nginx官方介绍</p><p><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/concat/">https://www.nginx.com/resources/wiki/modules/concat/</a></p><p>git地址</p><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nginx-http-concat">https://github.com/alibaba/nginx-http-concat</a></p><ul><li>安装</li></ul><p>下载源码到&#x2F;root目录</p><p>解压</p><p>nginx重新编译</p><p><font color="cornflowerblue">configure时记得加上自己原本有的后缀</font></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure .... --add-module=/root/nginx-http-concat-master/</span><br></pre></td></tr></table></figure><ul><li>make</li><li>备份复制nginx主程序</li><li>配置</li></ul><p>例如css引用：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;??font.css,bg.css&quot;</span><span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件：server或location</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">concat</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">concat_max_files</span> <span class="number">30</span>;</span><br></pre></td></tr></table></figure><h3 id="资源静态化"><a href="#资源静态化" class="headerlink" title="资源静态化"></a>资源静态化</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230627151618632.webp" alt="image-20230627151618632"></p><p><strong>高并发下：把资源做为静态资源放到Nginx。</strong></p><ul><li>类似于商品列表和详情页这种<font color="cornflowerblue">并发量高，但总体页面变化不大的页面</font>，</li><li>可以使用资源静态化的方式将请求的页面生成一个静态页面存储起来，每次直接返回静态页面即可</li><li>优点：商品列表和详情页的并发量高，可以跳过服务器计算和连接数据库读取数据的过程，直接返回静态页面，<font color="cornflowerblue">降低延迟度和并发量</font></li><li>静态页面存储在nginx，或者使用openresty技术（内置模板引擎，落地磁盘）直接跳过nginx连接DB生成静态页面</li><li>再使用异步请求的方式更新页面中变化的动态数据</li><li>nginx服务器需要用到<strong>rsync</strong>进行资源同步</li></ul><p><strong>例如一个item.html，可分为三个部分：</strong></p><ul><li><p>1.实际内容</p></li><li><p>2.固定公用-&gt;抽取 静态（<font color="cornflowerblue">例如header和footer，是common的</font>）</p><ul><li><p>前端-&gt;节约服务器端的计算资源消耗请求数</p></li><li><p>后端-&gt;使用SSI合并服务端文件（下一节讲），类似使用模板引擎（例如thymeleaf）</p></li></ul></li><li><p>3.关联的内容-&gt;引用 动态资源</p></li></ul><p>•高并发系统资源静态化方案</p><p>•一致性问题</p><p>•合并文件输出</p><p>•集群文件同步</p><p>生成静态页面自己去学</p><h3 id="SSI合并nginx服务器端文件"><a href="#SSI合并nginx服务器端文件" class="headerlink" title="SSI合并nginx服务器端文件"></a>SSI合并nginx服务器端文件</h3><p><font color="cornflowerblue">类似使用模板引擎（例如thymeleaf）</font></p><p>不推荐过于复杂使用ssi，否则高消耗服务器性能，专业的事交给模板引擎来做</p><p>服务端文件是nginx的文件，例如动静分离的静态文件html等等</p><p>官方文档：<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_ssi_module.html">http://nginx.org/en/docs/http/ngx_http_ssi_module.html</a></p><h4 id="配置文件配置"><a href="#配置文件配置" class="headerlink" title="配置文件配置"></a>配置文件配置</h4><ul><li><strong>ssi on|off</strong></li></ul><p>开启关闭ssi</p><ul><li><strong>ssi_last_modified on|off</strong></li></ul><p>是否保留lastmodified</p><p>默认off，每次输出的都是新文件</p><ul><li><strong>ssi_min_file_chunk size</strong></li></ul><p>向磁盘存储并使用sendfile发送，文件大小最小值</p><p>默认1k，当大于1k时存储再磁盘上并用sendfile发送</p><ul><li><strong>ssi_silent_errors on|off</strong></li></ul><p>不显示逻辑语法错误</p><p>默认off，当类似于 的语法错误，将直接返回不友好提示</p><p>on：语法错误时不提示，但是类似找不到文件，也会返回404错误提示</p><ul><li><strong>ssi_types</strong></li></ul><p>默认text&#x2F;html，只支持解析html的ssi功能</p><p>如果需要其他mime类型 需要设置</p><ul><li><strong>ssi_value_length length</strong></li></ul><p>限制脚本参数最大长度</p><p>要配置一般开启就行</p><p>配置在server或者location中</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssi</span> <span class="literal">on</span></span><br><span class="line">ssi_silent_errors <span class="literal">on</span></span><br></pre></td></tr></table></figure><h4 id="SSI命令配置"><a href="#SSI命令配置" class="headerlink" title="SSI命令配置"></a>SSI命令配置</h4><p>配置在配置文件配置ssi_types(例如html)中</p><ul><li><strong>include file</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# include file=&quot;footer.html&quot; --&gt;</span><br></pre></td></tr></table></figure><p>静态文件直接引用</p><ul><li><strong>block</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# block name=&quot;one&quot; --&gt;</span><br><span class="line">stub</span><br><span class="line">&lt;!--# endblock --&gt;</span><br></pre></td></tr></table></figure><p>可以声明一个ssi的命令块，里面可以包裹其他命令</p><ul><li><p><strong>config</strong></p><ul><li><p>1、errmsg:</p><p>配置文件配置ssi_silent_errors off时，即会返回不友好的语法错误提示</p><p>用于修改提示信息的内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[an error occurred while processing the directive]</span><br></pre></td></tr></table></figure><p>在模板中配置报错情况</p></li><li><p>2、timefmt:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%A, %d-%b-%Y %H:%M:%S %Z&quot;</span><br></pre></td></tr></table></figure><p>日期格式化</p></li></ul></li><li><p><strong>echo</strong></p><p>直接输出变量</p><ul><li>var变量名称</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# echo var=&quot;name” default=&quot;no” --&gt;</span><br></pre></td></tr></table></figure><ul><li><p>encoding 是否使用特殊编码格式</p></li><li><p>default 变量没有值的时候使用默认值</p></li></ul></li><li><p><strong>if</strong></p></li></ul><p>逻辑判断</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# if expr=&quot;...&quot; --&gt;</span><br><span class="line">...</span><br><span class="line">&lt;!--# elif expr=&quot;...&quot; --&gt;</span><br><span class="line">...</span><br><span class="line">&lt;!--# else --&gt;</span><br><span class="line">...</span><br><span class="line">&lt;!--# endif --&gt;</span><br><span class="line"></span><br><span class="line">eg：</span><br><span class="line">变量存在性检查：</span><br><span class="line">&lt;!--# if expr=&quot;$name&quot; --&gt;</span><br><span class="line">变量与文本的比较：</span><br><span class="line">&lt;!--# if expr=&quot;$name = text&quot; --&gt;</span><br><span class="line">&lt;!--# if expr=&quot;$name != text&quot; --&gt;</span><br><span class="line">变量与正则表达式的比较：</span><br><span class="line">&lt;!--# if expr=&quot;$name = /text/&quot; --&gt;</span><br><span class="line">&lt;!--# if expr=&quot;$name != /text/&quot; --&gt;</span><br><span class="line">如果 a 包含变量， 它们的值被替换。 正则表达式可以包含位置捕获和命名捕获 以后可以通过变量使用，例如：text</span><br><span class="line">&lt;!--# if expr=&quot;$name = /(.+)@(?P&lt;domain&gt;.+)/&quot; --&gt;</span><br><span class="line">    &lt;!--# echo var=&quot;1&quot; --&gt;</span><br><span class="line">    &lt;!--# echo var=&quot;domain&quot; --&gt;</span><br><span class="line">&lt;!--# endif --&gt;</span><br></pre></td></tr></table></figure><p><font color="cornflowerblue">正则不推荐使用，会高消耗服务器性能</font></p><ul><li><strong>include virtual</strong></li></ul><p>可以指向location，而不一定是具体文件</p><p>指定包含的请求，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# include virtual=&quot;/remote/body.php?argument=value&quot; --&gt;</span><br></pre></td></tr></table></figure><p>如果需要顺序处理，则应使用该参数。<code>wait</code></p><ul><li><strong>include wait</strong></li></ul><p>如果需要顺序处理，则应使用该参数。<code>wait</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# include virtual=&quot;/remote/body.php?argument=value&quot; wait=&quot;yes&quot; --&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>include stub</strong></li></ul><p>一个非标准参数，用于命名其块 如果包含的请求导致空，则将输出内容 正文，或者在请求处理过程中发生错误，例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# block name=&quot;one&quot; --&gt;&amp;nbsp;&lt;!--# endblock --&gt;</span><br><span class="line">&lt;!--# include virtual=&quot;/remote/body.php?argument=value&quot; stub=&quot;one&quot; --&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>include set</strong></li></ul><p>指示写入成功结果的非标准参数 对指定变量的请求处理， 例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--# include virtual=&quot;/remote/body.php?argument=value&quot; set=&quot;one&quot; --&gt;</span><br></pre></td></tr></table></figure><h3 id="rsync"><a href="#rsync" class="headerlink" title="rsync"></a>rsync</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230627184302481.webp" alt="image-20230627184302481"></p><p><a target="_blank" rel="noopener" href="https://www.samba.org/ftp/rsync/rsync.html">https://www.samba.org/ftp/rsync/rsync.html</a></p><p>remote synchronize是一个远程数据同步工具，可通过 LAN&#x2F;WAN 快速同步多台主机之间的文件。也可以使用 rsync 同步本地硬盘中的不同目录。<br>rsync 是用于替代 rcp 的一个工具，rsync 使用所谓的 rsync算法 进行数据同步，这种算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。</p><p>rsync 基于inotify 开发</p><p>Rsync有三种模式：</p><ul><li>本地模式（类似于cp命令）</li><li>远程模式（类似于scp命令）</li><li>守护进程（socket进程：是rsync的重要功能）</li></ul><h4 id="rsync手动拉取同步源文件"><a href="#rsync手动拉取同步源文件" class="headerlink" title="rsync手动拉取同步源文件"></a>rsync手动拉取同步源文件</h4><p><strong>安装</strong></p><p>两端安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rsync</span><br></pre></td></tr></table></figure><p><strong>源服务器修改配置文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.conf</span><br></pre></td></tr></table></figure><p>内容：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ftp]</span><br><span class="line">       <span class="attribute">path</span> = /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p><strong>源服务器启动rsync</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync--daemon</span><br></pre></td></tr></table></figure><p><strong>目标服务器查看源文件夹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --list-only 192.168.111.100::ftp/</span><br></pre></td></tr></table></figure><p>ftp&#x2F;为源服务器配置文件配置的[ftp]</p><p><strong>目标服务器手动拉取同步文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz 192.168.111.100::ftp/ /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p>同步到自己的&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html目录下</p><p><font color="cornflowerblue">现在只能增量同步</font>，若要删除源服务器没有的文件，需要加上参数实现完全同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--delete</span><br></pre></td></tr></table></figure><h4 id="增加安全认证及免密"><a href="#增加安全认证及免密" class="headerlink" title="增加安全认证及免密"></a>增加安全认证及免密</h4><p><strong>源服务器增加密码文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;sgg:111&quot; &gt;&gt; /etc/rsyncd.pwd</span><br><span class="line"></span><br><span class="line">chmod 600 /etc/rsyncd.pwd</span><br></pre></td></tr></table></figure><p><strong>源服务器修改配置文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">auth users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.pwd</span><br><span class="line"></span><br><span class="line">[ftp]</span><br><span class="line">       path = /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p><strong>源服务器重启rsync</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep rsync</span><br><span class="line">kill -9 进程号</span><br><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure><p><strong>目标服务器输入密码登录查看</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --list-only sgg@192.168.111.100::ftp/</span><br></pre></td></tr></table></figure><p><strong>目标服务器创建client密码文件</strong>	<strong>实现免密</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;111&quot; &gt;&gt; /etc/rsyncd.pwd.client</span><br><span class="line">chmod 600 /etc/rsyncd.pwd.client</span><br><span class="line"></span><br><span class="line">rsync --list-only --password-file=/etc/rsyncd.pwd.client sgg@192.168.111.100::ftp/</span><br><span class="line"></span><br><span class="line">rsync -avz --password-file=/etc/rsyncd.pwd.client sgg@192.168.111.100::ftp/ /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p>此时在客户端已经可以配合脚本实现定时同步了</p><p><font color="cornflowerblue">现在只能增量同步</font>，若要删除源服务器没有的文件，需要加上参数实现完全同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--delete</span><br></pre></td></tr></table></figure><h4 id="源服务器推送文件"><a href="#源服务器推送文件" class="headerlink" title="源服务器推送文件"></a>源服务器推送文件</h4><p><strong>目标服务器增加密码文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;sgg:111&quot; &gt;&gt; /etc/rsyncd.pwd</span><br><span class="line">chmod 600 /etc/rsyncd.pwd</span><br></pre></td></tr></table></figure><p><strong>目标服务器修改配置文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyncd.conf</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">auth</span> users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.pwd</span><br><span class="line">read only = <span class="literal">no</span>		<span class="comment">#关闭只读，让别人可以写进来</span></span><br><span class="line"></span><br><span class="line">[ftp]</span><br><span class="line">       path = /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p><strong>目标服务器启动rsync</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure><p><strong>源服务器创建client密码文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;111&quot; &gt;&gt; /etc/rsyncd.pwd.client</span><br><span class="line">chmod 600 /etc/rsyncd.pwd.client</span><br></pre></td></tr></table></figure><p><strong>源服务器推送给目标服务器</strong></p><p>与拉取比只是交换了目录和目标ip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --password-file=/etc/rsyncd.pwd.client /usr/local/nginx/html/ sgg@192.168.111.101::ftp/ </span><br></pre></td></tr></table></figure><p>注意发送目录&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;最后要加	‘&#x2F;‘，否则发送的是文件夹，不是文件夹下的东西</p><p><font color="cornflowerblue">现在只能增量同步</font>，若要删除源服务器没有的文件，需要加上参数实现完全同步：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--delete</span><br></pre></td></tr></table></figure><h4 id="inotify监控自动推送"><a href="#inotify监控自动推送" class="headerlink" title="inotify监控自动推送"></a>inotify监控自动推送</h4><p><strong>源服务器推送端安装inotify</strong></p><p>依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y automake</span><br></pre></td></tr></table></figure><p>下载上传tar包：</p><p>我的是 inotify-tools-3.14.tar.gz</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf inotify-tools-3.14.tar.gz</span><br></pre></td></tr></table></figure><p>configure</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd inotify-tools-3.14/</span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>源服务器监控目录</strong></p><p>监控源服务器的&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;目录</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/inotify/bin/<span class="attribute">inotifywait</span> -mrq --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span> --format <span class="string">&#x27;%T %w%f %e&#x27;</span> -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span><br></pre></td></tr></table></figure><p><strong>更改目标服务器配置文件</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">uid</span> = root		<span class="comment">#设置user</span></span><br><span class="line">gid = root		<span class="comment">#设置用户组</span></span><br><span class="line">auth users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.pwd</span><br><span class="line">read only = <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">[ftp]</span><br><span class="line">       path = /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p><strong>保证源和目标服务器rsync服务已启动且读取了最新配置文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep rsync</span><br><span class="line">kill -9 进程号</span><br><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure><p><strong>源服务器编写简单自动化脚本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/bin</span><br><span class="line">vim autoRsync.sh</span><br></pre></td></tr></table></figure><p>内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file</span><br><span class="line">do</span><br><span class="line">       </span><br><span class="line">        rsync -az --delete --password-file=/etc/rsyncd.pwd.client /usr/local/nginx/html/ sgg@192.168.111.101::ftp/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><strong>源服务器修改文件权限</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 autoRsync.sh</span><br><span class="line">chmod 777 /usr/local/nginx/html</span><br></pre></td></tr></table></figure><p><strong>启动脚本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoRsync.sh</span><br></pre></td></tr></table></figure><h4 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h4><p><strong>rsync 常用选项</strong></p><table><thead><tr><th align="left">选项</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">-a</td><td align="left">包含-rtplgoD</td></tr><tr><td align="left">-r</td><td align="left">同步目录时要加上，类似cp时的-r选项</td></tr><tr><td align="left">-v</td><td align="left">同步时显示一些信息，让我们知道同步的过程</td></tr><tr><td align="left">-l</td><td align="left">保留软连接</td></tr><tr><td align="left">-L</td><td align="left">加上该选项后，同步软链接时会把源文件给同步</td></tr><tr><td align="left">-p</td><td align="left">保持文件的权限属性</td></tr><tr><td align="left">-o</td><td align="left">保持文件的属主</td></tr><tr><td align="left">-g</td><td align="left">保持文件的属组</td></tr><tr><td align="left">-D</td><td align="left">保持设备文件信息</td></tr><tr><td align="left">-t</td><td align="left">保持文件的时间属性</td></tr><tr><td align="left">–delete</td><td align="left">删除DEST中SRC没有的文件</td></tr><tr><td align="left">–exclude</td><td align="left">过滤指定文件，如–exclude “logs”会把文件名包含logs的文件或者目录过滤掉，不同步</td></tr><tr><td align="left">-P</td><td align="left">显示同步过程，比如速率，比-v更加详细</td></tr><tr><td align="left">-u</td><td align="left">加上该选项后，如果DEST中的文件比SRC新，则不同步</td></tr><tr><td align="left">-z</td><td align="left">传输时压缩</td></tr></tbody></table><p><strong>inotify常用参数</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>含义</th></tr></thead><tbody><tr><td>-r</td><td>–recursive</td><td>#递归查询目录</td></tr><tr><td>-q</td><td>–quiet</td><td>#打印很少的信息，仅仅打印监控事件信息</td></tr><tr><td>-m</td><td>–monitor</td><td>#始终保持事件监听状态</td></tr><tr><td>–excludei</td><td></td><td>#排除文件或目录时，不区分大小写</td></tr><tr><td>–timefmt</td><td></td><td>#指定事件输出格式</td></tr><tr><td>–format</td><td></td><td>#打印使用指定的输出类似格式字符串</td></tr><tr><td>-e</td><td>–event[ -e|–event … ]accessmodifyattribcloseopenmove_tomove createdeleteumount</td><td>#通过此参数可以指定要监控的事件 #文件或目录被读取#文件或目录的内容被修改#文件或目录属性被改变#文件或目录封闭，无论读&#x2F;写模式#文件或目录被打开#文件或目录被移动至另外一个目录#文件或目录被移动另一个目录或从另一个目录移动至当前目录#文件或目录被创建在当前目录#文件或目录被删除#文件系统被卸载</td></tr></tbody></table><h2 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230628204302590.webp" alt="image-20230628204302590"></p><h3 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h3><p><strong>什么时候可以用缓存？</strong></p><ol><li>不常改变的内容</li><li>过期时间</li><li>针对post&#x2F;get请求都可以</li><li>存储位置</li><li>磁盘使用空间限制</li></ol><p>观察京东缓存及加载速度</p><ul><li>deskcache</li></ul><p>字面理解是从内存中，其实也是字面的含义，这个资源是直接从内存中拿到的，<strong>不会请求服务器</strong>一般已经加载过该资源且缓存在了内存当中，当关闭该页面时，此资源就被内存释放掉了，再次重新打开相同页面时不会出现from memory cache的情况</p><ul><li>memorycache</li></ul><p>是从磁盘当中取出的，也是在已经在之前的某个时间加载过该资源，<strong>不会请求服务器</strong>但是此资源不会随着该页面的关闭而释放掉，因为是存在硬盘当中的，下次打开仍会from disk cache</p><p><strong>Age</strong></p><p>是CDN添加的属性表示在CDN中缓存了多少秒</p><p><strong>via</strong></p><p>用来标识CDN缓存经历了哪些服务器，缓存是否命中，使用的协议</p><h4 id="强制缓存"><a href="#强制缓存" class="headerlink" title="强制缓存"></a>强制缓存</h4><p><strong>cache-control</strong></p><p>http1.1的规范，使用max-age表示文件可以在浏览器中缓存的时间以秒为单位</p><table><thead><tr><th align="left">标记</th><th>类型</th><th>功能</th></tr></thead><tbody><tr><td align="left">public</td><td>响应头</td><td>响应的数据可以被缓存，客户端和代理层都可以缓存</td></tr><tr><td align="left">private</td><td>响应头</td><td>可私有缓存，客户端可以缓存，代理层不能缓存（CDN，proxy_pass）</td></tr><tr><td align="left">no-cache</td><td>请求头</td><td>可以使用本地缓存，但是必须发送请求到服务器回源验证</td></tr><tr><td align="left">no-store</td><td>请求和响应</td><td>应禁用缓存</td></tr><tr><td align="left">max-age</td><td>请求和响应</td><td>文件可以在浏览器中缓存的时间以秒为单位</td></tr><tr><td align="left">s-maxage</td><td>请求和响应</td><td>用户代理层缓存，CDN下发，当客户端数据过期时会重新校验</td></tr><tr><td align="left">max-stale</td><td>请求和响应</td><td>缓存最大使用时间，如果缓存过期，但还在这个时间范围内则可以使用缓存数据</td></tr><tr><td align="left">min-fresh</td><td>请求和响应</td><td>缓存最小使用时间，</td></tr><tr><td align="left">must-revalidate</td><td>请求和响应</td><td>当缓存过期后，必须回源重新请求资源。比no-cache更严格。因为HTTP 规范是允许客户端在某些特殊情况下直接使用过期缓存的，比如校验请求发送失败的时候。那么带有must-revalidate的缓存必须校验，其他条件全部失效。</td></tr><tr><td align="left">proxy-revalidate</td><td>请求和响应</td><td>和must-revalidate类似，只对CDN这种代理服务器有效，客户端遇到此头，需要回源验证</td></tr><tr><td align="left">stale-while-revalidate</td><td>响应</td><td>表示在指定时间内可以先使用本地缓存，后台进行异步校验</td></tr><tr><td align="left">stale-if-error</td><td>响应</td><td>在指定时间内，重新验证时返回状态码为5XX的时候，可以用本地缓存</td></tr><tr><td align="left">only-if-cached</td><td>响应</td><td>那么只使用缓存内容，如果没有缓存 则504 getway timeout</td></tr></tbody></table><p>在浏览器和服务器端验证文件是否过期的时候，浏览器在二次请求的时候会携带IF-Modified-Since属性</p><p><strong>Expires</strong></p><p>设置强制缓存过期时间</p><p><strong>配置</strong></p><p><font color="cornflowerblue">location中</font></p><p><strong>使用expires配置</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expires 30s;   #缓存30秒</span><br><span class="line">expires 30m;  #缓存30分钟   </span><br><span class="line">expires 2h;     #缓存2小时</span><br><span class="line">expires 30d;    #缓存30天</span><br></pre></td></tr></table></figure><p><strong>使用cache-control</strong></p><p>优先级高于expires</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_header cache-control &quot;max-age:300&quot;;		#单位s</span><br></pre></td></tr></table></figure><p><font color="cornflowerblue">浏览器缓存很取决于浏览器的策略，一般只会在新标签页的首次访问才会使用强制缓存</font></p><h4 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h4><p><strong>last-modified</strong></p><p><strong>etag</strong></p><p>http1.1支持</p><p>在HTTP协议中If-Modified-Since和If-None-Match分别对应Last-Modified和ETag</p><p>Entity Tag 的缩写，中文译过来就是实体标签的意思.</p><p>HTTP中并没有指定如何生成ETag，哈希是比较理想的选择。</p><p>在计算Etag的时候，会产生CPU的耗费，所以也可以用时间戳，但这样直接使用Last-Modified即可。</p><p>ETag 用来校验用户请求的资源是否有变化，作用和lastmodified很像，区别是lastmodified精确到秒，ETag可以用hash算法来生成更精确的比对内容。</p><p><strong>当用户首次请求资源的时候返回给用户数据和200状态码并生成ETag，再次请求的时候服务器比对ETag，没有发生变化的话返回304</strong></p><p>Cache-Control直接是通过不请求来实现，而ETag是会发请求的，只不过服务器根据请求的东西的内容有无变化来判断是否返回请求的资源</p><p><strong>配置</strong></p><p>Http1.1自带协商缓存，一般浏览器默认开启</p><p><strong>禁用协商缓存：</strong></p><p>server或location</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etag off;</span><br><span class="line">if_modified_since off;</span><br><span class="line">或</span><br><span class="line">etag off;</span><br><span class="line">add_header Last-Modified &quot;&quot;;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul><li><p><strong>cache-control | expires 强制缓存</strong></p><ul><li>浏览器缓存很取决于浏览器的策略，一般只会在新标签页的首次访问才会使用强制缓存</li></ul></li><li><p><strong>etag | lastmodify 协商缓存</strong></p><ul><li>发送请求header中携带Last-Modified，若未修改服务器会返回304 Not Modified</li></ul></li><li><p><strong>强制缓存和协商缓存可配合使用</strong></p><ul><li>首次访问使用强制缓存，用户手动刷新将会发送请求，若服务器判断未修改，则返回304</li></ul></li><li><p><strong>last-modified 会与ssi的冲突</strong></p></li><li><p><strong>浏览器缓存原则</strong></p><ul><li><p>多级集群负载时last-modified必须<strong>保持一致</strong></p></li><li><p>还有一些场景下我们希望禁用浏览器缓存。比如轮训api上报数据数据</p></li><li><p>浏览器缓存很难彻底禁用，大家的做法是加版本号，随机数等方法。</p></li><li><p>只缓存200响应头的数据，像3XX这类跳转的页面不需要缓存。</p></li><li><p>对于js，css这类可以缓存很久的数据，可以通过加版本号的方式更新内容</p></li><li><p>不需要强一致性的数据，可以缓存几秒</p></li><li><p>异步加载的接口数据，可以使用ETag来校验。</p></li><li><p>在服务器添加Server头，有利于排查错误</p></li><li><p>分为手机APP和Client以及是否遵循http协议</p></li><li><p>在没有联网的状态下可以展示数据</p></li><li><p>流量消耗过多</p></li><li><p><strong>提前下发</strong> 避免秒杀时同时下发数据造成流量短时间暴增</p></li><li><p><strong>兜底数据</strong> 在服务器崩溃和网络不可用的时候展示</p></li><li><p>临时缓存 退出即清理</p></li><li><p>固定缓存 展示框架这种，可能很长时间不会更新，可用随客户端下发</p><ul><li><strong>首页</strong>有的时候可以看做是框架，首页经常变化应该禁用缓存，以保证加载的资源都是最新的</li></ul></li><li><p>父子连接 页面跳转时有一部分内容不需要重新加载，可用从父菜单带过来</p></li><li><p>预加载 某些逻辑可用判定用户接下来的操作，那么可用异步加载那些资源</p></li><li><p>漂亮的加载过程 异步加载 先展示框架，然后异步加载内容，避免主线程阻塞</p></li></ul></li></ul><h3 id="GEOip"><a href="#GEOip" class="headerlink" title="GEOip"></a>GEOip</h3><p>根据用户的ip获取用户所在地</p><p><strong>1 下载数据库</strong></p><p>官网需注册登录,下载数据库</p><p>maxmind.com</p><p>数据库有country版和city版是免费的，商业版更精确需要收费</p><p><strong>2 安装依赖</strong></p><p>官方git	<a target="_blank" rel="noopener" href="https://github.com/maxmind/libmaxminddb">https://github.com/maxmind/libmaxminddb</a></p><p>下载后执行编译安装之后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf </span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure><p><strong>Nginx模块</strong></p><p><a target="_blank" rel="noopener" href="https://github.com/leev/ngx_http_geoip2_module">https://github.com/leev/ngx_http_geoip2_module</a></p><p>更完整的配置可参考官方文档</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_geoip_module.html#geoip_proxy">http://nginx.org/en/docs/http/ngx_http_geoip_module.html#geoip_proxy</a></p><p>编译安装，不再讲</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=......	--with.......... --add-module=/root/ngx_http_geoip2_module</span><br></pre></td></tr></table></figure><p><strong>Nginx配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http添加</span></span><br><span class="line"><span class="attribute">geoip2</span> /root/GeoLite2-ASN_20220524/GeoLite2-ASN.mmdb &#123;</span><br><span class="line">    $<span class="attribute">geoip2_country_code</span> country iso_code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#location添加</span></span><br><span class="line"><span class="attribute">add_header</span> country <span class="variable">$geoip2_country_code</span>;</span><br></pre></td></tr></table></figure><h3 id="正向代理配置"><a href="#正向代理配置" class="headerlink" title="正向代理配置"></a>正向代理配置</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server中配置google提供的DNS服务器进行解析</span></span><br><span class="line"><span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#location中</span></span><br><span class="line"><span class="attribute">proxy_pass</span> <span class="variable">$scheme</span>://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br></pre></td></tr></table></figure><p>还需要在浏览器中设置代理服务器的信息，设置过后就可以正常代理访问http请求了</p><p>若要能访问https请求，还需要添加下面的模块（一般不会使用nginx作为正向代理服务器）</p><p><strong>代理https请求</strong></p><p>需要第三方模块</p><p><a target="_blank" rel="noopener" href="https://github.com/chobits/ngx_http_proxy_connect_module">https://github.com/chobits/ngx_http_proxy_connect_module</a></p><p>下载后对nginx进行重新编译</p><p><strong>配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>                         <span class="number">3128</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dns resolver used by forward proxying</span></span><br><span class="line">    <span class="attribute">resolver</span>                       <span class="number">8.8.8.8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for CONNECT request</span></span><br><span class="line">    proxy_connect;</span><br><span class="line">    <span class="attribute">proxy_connect_allow</span>            <span class="number">443</span> <span class="number">563</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_connect_timeout</span>  <span class="number">10s</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_read_timeout</span>     <span class="number">10s</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_send_timeout</span>     <span class="number">10s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward proxy for non-CONNECT request</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://<span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反向代理proxy缓存"><a href="#反向代理proxy缓存" class="headerlink" title="反向代理proxy缓存"></a>反向代理proxy缓存</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230628204302590.webp" alt="image-20230628204302590"></p><p>将资源缓存在nginx服务器</p><p>自己的理解：<font color="cornflowerblue">与动静分离类似</font>，只不过动静分离在静态资源文件夹更新数据，而反向代理缓存则是设定的时间过期过后可以重新向tomcat发送请求拉取数据，<font color="cornflowerblue">并且缓存会缓存发起请求时的动态数据</font></p><p>官网解释</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache</a></p><h4 id="最小配置"><a href="#最小配置" class="headerlink" title="最小配置"></a>最小配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http模块：</span></span><br><span class="line"><span class="attribute">proxy_cache_path</span> /ngx_tmp levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=test_cache:<span class="number">100m</span> inactive=<span class="number">1d</span> max_size=<span class="number">10g</span>;</span><br><span class="line"><span class="comment">#缓存存储目录：/ngx_tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#location模块：</span></span><br><span class="line"><span class="attribute">add_header</span>  Nginx-Cache <span class="string">&quot;<span class="variable">$upstream_cache_status</span>&quot;</span>;</span><br><span class="line"><span class="attribute">proxy_cache</span> test_cache;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">1h</span>;		<span class="comment">#缓存过期时间</span></span><br></pre></td></tr></table></figure><h4 id="缓存清理"><a href="#缓存清理" class="headerlink" title="缓存清理"></a>缓存清理</h4><p><strong>purger</strong></p><p>手动清理缓存，需要第三方模块支持</p><p><a target="_blank" rel="noopener" href="https://github.com/FRiCKLE/ngx_cache_purge">https://github.com/FRiCKLE/ngx_cache_purge</a></p><p>下载解压后使用–add-module重新编译nginx</p><p><strong>最小配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">#新增location</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /purge(/.*)</span> &#123;</span><br><span class="line"></span><br><span class="line">          <span class="attribute">proxy_cache_purge</span>  test_cache  <span class="variable">$1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line"><span class="comment">#proxy缓存配置的location中：</span></span><br><span class="line">      <span class="attribute">proxy_cache_key</span> <span class="variable">$uri</span>;	<span class="comment">#自定义cachekey</span></span><br></pre></td></tr></table></figure><p>其中，proxy_cache_key为设置的key，purger会根据设置的key删除指定的缓存</p><p>目前只根据uri为key删除缓存</p><p><strong>示例：</strong></p><p>以及访问了192.168.111.100&#x2F;test.html，此时nginx缓存该页面，该页面的key为test.html，</p><p><strong>若要清除该缓存，则浏览器访问：192.168.111.100&#x2F;purge&#x2F;test.html</strong></p><p>配置以主机名+uri+参数作为key：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">#新增location</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /purge(/.*)</span> &#123;</span><br><span class="line"></span><br><span class="line">          <span class="attribute">proxy_cache_purge</span>  test_cache  <span class="variable">$host</span><span class="variable">$1</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line"><span class="comment">#proxy缓存配置的location中：</span></span><br><span class="line">      <span class="attribute">proxy_cache_key</span> <span class="variable">$host</span><span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;	<span class="comment">#自定义cachekey</span></span><br></pre></td></tr></table></figure><p>proxy_cache_key和proxy_cache_purge要对应修改</p><h4 id="断点续传缓存range"><a href="#断点续传缓存range" class="headerlink" title="断点续传缓存range"></a>断点续传缓存range</h4><p>当有完整的content-length之后即可断点续传</p><p>在反向代理服务器中需向后传递header</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Range $http_range;</span><br></pre></td></tr></table></figure><p>proxy_cache_key中增加range</p><p>根据header中的Range获取对应的partial-content，会返回206</p><h4 id="详细配置"><a href="#详细配置" class="headerlink" title="详细配置"></a>详细配置</h4><ul><li><strong>proxy_cache_key</strong></li></ul><p>默认<code>$scheme$proxy_host$request_uri</code></p><p>缓存的key</p><ul><li><strong>proxy_cache_revalidate</strong></li></ul><p>过期后可以和协商缓存类似，如果缓存过期了，向上游服务器发送“If-Modified-Since” and “If-None-Match来验证是否改变，如果没有就不需要重新下载资源了</p><ul><li><strong>proxy_cache_valid</strong></li></ul><p>可以针对不容http状态码设置缓存过期时间</p><p>不设置状态码会默认200, 301, 302</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 301      1h;</span><br><span class="line">proxy_cache_valid any      1m;</span><br></pre></td></tr></table></figure><p>any指其他任意状态码</p><ul><li><strong>proxy_cache_use_stale</strong></li></ul><p>默认off</p><p>在什么时候可以使用过期缓存</p><p>可选<code>error</code> | <code>timeout</code> | <code>invalid_header</code> | <code>updating</code> | <code>http_500</code> | <code>http_502</code> | <code>http_503</code> | <code>http_504</code> | <code>http_403</code> | <code>http_404</code> | <code>http_429</code> | <code>off</code></p><ul><li><strong>proxy_cache_background_update</strong></li></ul><p>默认off</p><p>运行开启子请求更新过期的内容。同时会把过期的内容返回给客户端</p><ul><li><strong>proxy_no_cache</strong> <strong>proxy_cache_bypass</strong></li></ul><p>指定什么时候不使用缓存而直接请求上游服务器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_no_cache $cookie_nocache $arg_nocache$arg_comment;</span><br><span class="line">proxy_no_cache $http_pragma    $http_authorization;</span><br></pre></td></tr></table></figure><p>如果这些变量如果存在的话不为空或者不等于0，则不使用缓存</p><ul><li><strong>proxy_cache_convert_head</strong></li></ul><p>默认 on</p><p>是否把head请求转换成get请求后再发送给上游服务器 以便缓存body里的内容</p><p>如果关闭 需要在 <code>cache key</code> 中添加 $request_method 以便区分缓存内容</p><ul><li><strong>proxy_cache_lock</strong></li></ul><p>默认off</p><p>缓存更新锁</p><ul><li><strong>proxy_cache_lock_age</strong></li></ul><p>默认5s</p><p>缓存锁超时时间</p><ul><li><strong>proxy_cache_max_range_offset</strong></li></ul><p>range最大值，超过之后不做缓存，默认情况下 不需要对单文件较大的资源做缓存</p><ul><li><strong>proxy_cache_methods</strong></li></ul><p>默认 head get</p><ul><li><strong>proxy_cache_min_uses</strong></li></ul><p>默认1</p><p>被请求多少次之后才做缓存</p><ul><li><strong>proxy_cache_path</strong></li></ul><p>path 指定存储目录</p><p>以cache_key取md5值</p><ul><li><strong>levels&#x3D;1:2</strong></li></ul><p>目录层级数及目录名称位数</p><p>取mdb5后几位</p><p>TMPFS</p><ul><li><strong>use_temp_path</strong></li></ul><p>默认创建缓存文件时，先向缓冲区创建临时文件，再移动到缓存目录</p><p>是否使用缓冲区</p><ul><li><strong>inactive</strong></li></ul><p>指定时间内未被访问过的缓存将被删除</p><h1 id="第二部分-高效"><a href="#第二部分-高效" class="headerlink" title="第二部分 高效"></a>第二部分 高效</h1><h2 id="Nginx内存缓存"><a href="#Nginx内存缓存" class="headerlink" title="Nginx内存缓存"></a>Nginx内存缓存</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230628204302590.webp" alt="image-20230628204302590"></p><p><strong>适用场景</strong>：内存高速，但是内存较小，一般应用为静态文件元数据（索引）信息缓存、热点数据缓存</p><p><strong>strace追踪内核</strong></p><p>追踪内核查看sendfile执行过程</p><p>安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y strace</span><br></pre></td></tr></table></figure><p>追踪：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx</span><br><span class="line">strace -p 进程号	#nginx第一个worker的进程号</span><br></pre></td></tr></table></figure><p>sendfile执行过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">epoll_wait(8, [&#123;EPOLLIN, &#123;u32=1904243152, u64=140709327827408&#125;&#125;, &#123;EPOLLIN, &#123;u32=1904242704, u64=140709327826960&#125;&#125;], 512, 25215) = 2</span><br><span class="line">recvfrom(10, &quot;GET / HTTP/1.1\r\nHost: 192.168.44&quot;..., 1024, 0, NULL, NULL) = 475</span><br><span class="line">stat(&quot;/usr/local/nginx//html/index.html&quot;, &#123;st_mode=S_IFREG|0644, st_size=1429, ...&#125;) = 0</span><br><span class="line">open(&quot;/usr/local/nginx//html/index.html&quot;, O_RDONLY|O_NONBLOCK) = 11</span><br><span class="line">fstat(11, &#123;st_mode=S_IFREG|0644, st_size=1429, ...&#125;) = 0</span><br><span class="line">writev(10, [&#123;iov_base=&quot;HTTP/1.1 200 OK\r\nServer: nginx/1&quot;..., iov_len=263&#125;], 1) = 263</span><br><span class="line">sendfile(10, 11, [0] =&gt; [1429], 1429)   = 1429</span><br><span class="line">write(4, &quot;192.168.44.1 - - [27/May/2022:14&quot;..., 193) = 193</span><br><span class="line">close(11) </span><br></pre></td></tr></table></figure><p>使用sendfile，上面执行过程将不会具体读取文件内容，<font color="cornflowerblue">sendfile是使用内存的</font></p><p><strong>open_file_cache配置</strong></p><p>这里是缓存在内存中的，<strong>用于加速sendfile</strong></p><p>配置在server下</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">open_file_cache</span> max=<span class="number">500</span> inactive=<span class="number">60s</span>;</span><br><span class="line"><span class="attribute">open_file_cache_min_uses</span> <span class="number">1</span>; </span><br><span class="line"><span class="attribute">open_file_cache_valid</span> <span class="number">60s</span>; </span><br><span class="line"><span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>;</span><br></pre></td></tr></table></figure><p><strong>max</strong>缓存最大数量，超过数量后会使用LRU淘汰</p><p><strong>inactive</strong> 指定时间内未被访问过的缓存将被删除</p><p><strong>pen_file_cache_min_uses</strong></p><p>被访问到多少次后会开始缓存</p><p><strong>open_file_cache_valid</strong></p><p>间隔多长时间去检查文件是否有变化</p><p><strong>open_file_cache_errors</strong></p><p>对错误信息是否缓存</p><h2 id="Nginx外置缓存缓存"><a href="#Nginx外置缓存缓存" class="headerlink" title="Nginx外置缓存缓存"></a>Nginx外置缓存缓存</h2><p>通过网络使用其他机器的内存</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_memcached_module.html">http://nginx.org/en/docs/http/ngx_http_memcached_module.html</a></p><h3 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h3><p>指定状态码，默认指向location</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">302</span> http://www.atguigu.com;		<span class="comment">#若404则返回302重定向到http://www.atguigu.com</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /<span class="number">401</span>.html	<span class="comment">#若2404则返回200然后跳转到401页面</span></span><br></pre></td></tr></table></figure><p><font color="cornflowerblue"><code>=</code>	后面不能有空格</font></p><h3 id="匿名location"><a href="#匿名location" class="headerlink" title="匿名location"></a>匿名location</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =@<span class="number">666</span>;</span><br><span class="line"><span class="section">location</span> @<span class="number">666</span> &#123;</span><br><span class="line">    <span class="attribute">add_header</span> content-type <span class="string">&quot;text/html&quot;</span>;	<span class="comment">#若加了content-type，浏览器就知道怎么处理文本，不加则不显示</span></span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;hi world!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>若未指定content-type，返回的返回的数据不会被展示，状态码为<strong>886</strong>，代表浏览器不知道怎么处理数据，会下载返回的数据到本机</p><p>此配置代表：若404，则跳转到自定义页面	&#x2F;666&#x2F;index.html，状态码为200，网页内容为	hi world!</p><h3 id="nginx-memcached"><a href="#nginx-memcached" class="headerlink" title="nginx + memcached"></a>nginx + memcached</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.hahhome.top/blog/Nginx%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B%E6%89%A9%E5%AE%B9%E4%B8%8E%E9%AB%98%E6%95%88/../../image/nginxadvanced.assets/image-20230629175942043.webp" alt="image-20230629175942043"></p><p><strong>作用：将 <code>uri+args</code> 作为key存储在内存当中，当用户请求对应的uri时，从内存中找到后直接返回给用户，若未找到，则反向代理到上游服务器，然后将数据添加到内存中再返回给用户。</strong></p><p><code>memcached：内存缓存</code></p><p><strong>memcached安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install memcached</span><br></pre></td></tr></table></figure><p>默认配置文件在</p><p><code>/etc/sysconfig/memcached</code></p><p>查看状态</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start memcached</span><br><span class="line">memcached-tool 127.0.0.1:11211  stats</span><br></pre></td></tr></table></figure><p><strong>安装telnet</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install telnet</span><br></pre></td></tr></table></figure><p>向内存写东西</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 11211</span><br><span class="line">set [key] 0 0 3		#0 0 x	： x个字节</span><br><span class="line">123</span><br><span class="line">get [key]</span><br></pre></td></tr></table></figure><p>为下面nginx实验写入数据准备：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set /? 0 0 5</span><br><span class="line">12345</span><br></pre></td></tr></table></figure><p><strong>nginx配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  	<span class="section">upstream</span> backend &#123;</span><br><span class="line">  		<span class="attribute">server</span> <span class="number">192.168.44.104:8080</span>;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">   	<span class="section">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">       <span class="attribute">set</span> 		   <span class="variable">$memcached_key</span> <span class="string">&quot;<span class="variable">$uri</span>?<span class="variable">$args</span>&quot;</span>;		<span class="comment">#uri+args作为key</span></span><br><span class="line">       <span class="attribute">memcached_pass</span> <span class="number">127.0.0.1:11211</span>;</span><br><span class="line"></span><br><span class="line">       <span class="attribute">add_header</span> X-Cache-Satus HIT;</span><br><span class="line">       <span class="attribute">add_header</span> Content-Type <span class="string">&#x27;text/html; charset=utf-8&#x27;</span>; <span class="comment"># 强制响应数据格式为html</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># root   html;		#内存中没有内容则发出请求请求数据添加到内存，不需要返回页面了</span></span><br><span class="line">    	&#125;</span><br><span class="line">   </span><br><span class="line">   	<span class="attribute">error_page</span> <span class="number">404</span> =<span class="variable">@fallback</span>;</span><br><span class="line">   	</span><br><span class="line">    <span class="section">location</span> <span class="variable">@fallback</span> &#123;</span><br><span class="line">       	<span class="attribute">proxy_set_header</span> memcached_key <span class="variable">$memcached_key</span>;</span><br><span class="line">       	<span class="attribute">proxy_pass</span> http://192.168.44.104:8080;</span><br><span class="line">   	&#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>uri+args</code> 作为key存储在内存当中，当用户请求对应的uri时，从内存中找到后直接返回给用户，若未找到，则反向代理到上游服务器，然后将数据添加到内存中再返回给用户。</p><p>这里我们是去前面手动写入第一次访问的数据12345，真实场景中需要后端tomcat服务器来写入</p><h3 id="nginx-redis"><a href="#nginx-redis" class="headerlink" title="nginx + redis"></a>nginx + redis</h3><p><font color="cornflowerblue">nginx连接redis或者mysql用于直接从nginx获取redis、mysql中的数据，简化从tomcat让tomcat连接数据库再传值回来，数据库中的值的写入由tomcat完成，nginx只需要读取就好</font><br>以上功能主要由后面讲的openresty处实现，这里主要讲外置缓存</p><p><strong>redis快速安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install -y redis</span><br></pre></td></tr></table></figure><p>也可以自己下载后规范安装：<a target="_blank" rel="noopener" href="https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.0">https://codeload.github.com/redis/redis/tar.gz/refs/tags/7.0.0</a></p><p><strong>redis2-nginx-module</strong></p><p>redis2-nginx-module是一个支持 Redis 2.0 协议的 Nginx upstream 模块，它可以让 Nginx 以非阻塞方式直接防问远方的 Redis 服务，同时支持 TCP 协议和 Unix Domain Socket 模式，并且可以启用强大的 Redis 连接池功能。</p><p><a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/redis2/">https://www.nginx.com/resources/wiki/modules/redis2/</a></p><p><a target="_blank" rel="noopener" href="https://github.com/openresty/redis2-nginx-module">https://github.com/openresty/redis2-nginx-module</a></p><p>上传后解压，重新编译nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/nginx-1.21.6</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-stream --with-http_gzip_static_module --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d --add-module=/root/redis2-nginx-module-0.15</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">cd objs</span><br><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class="line">cp nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure><p><strong>启动redis</strong></p><p>规范安装示例，快速安装应该已经自动启动和配置好了redis-server</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在根目录下创建一个目录/myredis，并将/opt/redis-7.0.10/redis.conf文件复制到myredis目录下，保留原文件</span><br><span class="line">/myredis/redis.conf配置文件的修改：</span><br><span class="line">​	1.将daemonize no 改为 daemonize yes</span><br><span class="line">​	2.protected-mode yes 改为protected-mode no</span><br><span class="line">​	3.注释掉bind 127.0.0.1 -::1</span><br><span class="line">​	4.requirepass设置密码</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-server /myredis/redis.conf</span><br><span class="line">redis-cli</span><br><span class="line">auth [password]</span><br><span class="line">ping	#若弹出pong则为连接客户端成功</span><br></pre></td></tr></table></figure><p><strong>配置</strong></p><p><strong>test</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /foo &#123;</span><br><span class="line"></span><br><span class="line">	 <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;	<span class="comment">#自己的redis密码</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>浏览器访问192.168.111.100&#x2F;foo可以向redis中写值，根据配置，写的键值对为	<code>one:fire</code></p><p><strong>get</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /get &#123;</span><br><span class="line"></span><br><span class="line">	 <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;	<span class="comment">#自己的redis密码</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">#set_unescape_uri $key $arg_key;  # this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get <span class="variable">$arg_key</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>浏览器访问 192.168.111.100&#x2F;get?key&#x3D;one	可获得one的值</p><p><strong>set</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /set?key=one&amp;val=first%20value</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /set &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">127.0.0.1:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$val</span> <span class="variable">$arg_val</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set <span class="variable">$key</span> <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>pipeline</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">redis2_query</span> set one two;</span><br><span class="line"></span><br><span class="line">   <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> del key1;</span><br></pre></td></tr></table></figure><p><strong>list</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   redis2_query lpush key1 C;</span><br><span class="line"></span><br><span class="line">   redis2_query lpush key1 B;</span><br><span class="line"></span><br><span class="line">   redis2_query lpush key1 A;</span><br><span class="line"></span><br><span class="line">redis2_query lrange key1 <span class="number">0</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><p><strong>集群</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> redis_cluster &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /redis &#123;</span><br><span class="line"></span><br><span class="line">	  <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">      <span class="attribute">redis2_next_upstream</span> <span class="literal">error</span> timeout invalid_response;</span><br><span class="line"></span><br><span class="line">      <span class="attribute">redis2_query</span> get foo;</span><br><span class="line"></span><br><span class="line">      <span class="attribute">redis2_pass</span> redis_cluster;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Stream模块为nginx反向代理mysql"><a href="#Stream模块为nginx反向代理mysql" class="headerlink" title="Stream模块为nginx反向代理mysql"></a>Stream模块为nginx反向代理mysql</h2><p><font color="red">配置文件中和http同级，是提供tcp服务的配置</font></p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html">http://nginx.org/en/docs/stream/ngx_stream_core_module.html</a></p><p>重新编译nginx：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure ...... --with-stream </span><br><span class="line">make</span><br><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure><p>额外开两台mysql服务器，一主一从，</p><p>配置nginx服务器stream tcp服务，和http同级</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> mysql &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="attribute">server</span> <span class="number">192.168.111.101:3306</span>;</span><br><span class="line">		<span class="attribute">server</span> <span class="number">192.168.111.102:3306</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">3306</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>  mysql;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><p><strong>QPS限制</strong></p><p>官方文档</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html</a></p><p>测试工具</p><p><a target="_blank" rel="noopener" href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p><p>配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http中</span></span><br><span class="line"><span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=test:<span class="number">10m</span> rate=1r/s;</span><br><span class="line"><span class="comment">#zone=test：与location中zone对应</span></span><br><span class="line"><span class="comment">#rate=15r/s：限流，15qps每秒，每秒只接收15个请求</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#location中</span></span><br><span class="line"><span class="attribute">limit_req</span> zone=test		<span class="comment">#每秒处理500个请求</span></span><br><span class="line"></span><br><span class="line">limit_req zone=test burst=<span class="number">5</span>;	<span class="comment">#采用漏斗算法，允许平均每秒不超过1个请求，突发不超过5个请求。5个请求满后，后续请求全部排队，若排队超时则失败</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">limit_req</span> zone=test burst=<span class="number">5</span> nodelay;	<span class="comment">#如果不希望在限制请求时延迟过多的请求，则应使用参数nodelay，不会再有排队的请求，桶外请求全部快速失败</span></span><br></pre></td></tr></table></figure><p><strong>带宽限制</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#location中：</span></span><br><span class="line"><span class="attribute">limit_rate_after</span> <span class="number">1m</span>;	<span class="comment">#设置刚开始的带宽</span></span><br><span class="line"><span class="attribute">limit_rate</span> <span class="number">1k</span>;	<span class="comment">#设置带宽</span></span><br></pre></td></tr></table></figure><p><strong>并发数限制</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#http中</span></span><br><span class="line"><span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=test2:<span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#location中：</span></span><br><span class="line"><span class="attribute">limit_conn</span> test2 <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><ul><li><strong>ngx_http_log_module</strong></li></ul><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_log_module.html">http://nginx.org/en/docs/http/ngx_http_log_module.html</a></p><p>默认日志目录：</p><p>正常访问日志：nignx&#x2F;logs&#x2F;access.log</p><p>错误日志：nignx&#x2F;logs&#x2F;error.log</p><p>linux可使用	<code>tail -f /usr/local/nginx/logs/access.log</code>	实时追踪日志文件</p><ul><li><strong>ngx_http_empty_gif_module</strong></li></ul><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_empty_gif_module.html">http://nginx.org/en/docs/http/ngx_http_empty_gif_module.html</a></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /_.gif &#123;</span><br><span class="line">    empty_gif;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只有1个像素的gif，肉眼看不出，用于收集用户的行为信息</p><h3 id="access-log配置"><a href="#access-log配置" class="headerlink" title="access.log配置"></a>access.log配置</h3><p><strong>自定义日志格式</strong></p><p>| 语法: | <code>log_format name [escape=default|json|none] string ...;</code> |<br>| :—- | ——————————————————– |<br>| 默认: | <code>log_format combined &quot;...&quot;;</code> |</p><p>示例：http中：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法：log_format name [escape=default|json|none] string ...;</span></span><br><span class="line"><span class="attribute">log_format</span> logtest <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$request</span>&quot; <span class="variable">$status</span> <span class="variable">$bytes_sent</span> &#x27;</span></span><br><span class="line">                       <span class="string">&#x27;&quot;<span class="variable">$http_referer</span>&quot; &quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$gzip_ratio</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>日志内容格式定义为json示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> ngxlog json <span class="string">&#x27;&#123;&quot;timestamp&quot;:&quot;<span class="variable">$time_iso8601</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;source&quot;:&quot;<span class="variable">$server_addr</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;hostname&quot;:&quot;<span class="variable">$hostname</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;remote_user&quot;:&quot;<span class="variable">$remote_user</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;ip&quot;:&quot;<span class="variable">$http_x_forwarded_for</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;client&quot;:&quot;<span class="variable">$remote_addr</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;request_method&quot;:&quot;<span class="variable">$request_method</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;scheme&quot;:&quot;<span class="variable">$scheme</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;domain&quot;:&quot;<span class="variable">$server_name</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;referer&quot;:&quot;<span class="variable">$http_referer</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;request&quot;:&quot;<span class="variable">$request_uri</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;requesturl&quot;:&quot;<span class="variable">$request</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;args&quot;:&quot;<span class="variable">$args</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;size&quot;:<span class="variable">$body_bytes_sent</span>,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;status&quot;: <span class="variable">$status</span>,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;responsetime&quot;:<span class="variable">$request_time</span>,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;upstreamtime&quot;:&quot;<span class="variable">$upstream_response_time</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;upstreamaddr&quot;:&quot;<span class="variable">$upstream_addr</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;http_user_agent&quot;:&quot;<span class="variable">$http_user_agent</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;http_cookie&quot;:&quot;<span class="variable">$http_cookie</span>&quot;,&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;https&quot;:&quot;<span class="variable">$https</span>&quot;&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&#125;&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>自定义日志位置和其他设置</strong></p><table><thead><tr><th align="left">语法:</th><th><code>access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</code> <code>access_log off;</code></th></tr></thead><tbody><tr><td align="left">default:</td><td><code>access_log logs/access.log combined;</code></td></tr></tbody></table><p>示例：http中</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">access_log</span> /ngx_logs/nginx-access.log [logtest] [buffer=<span class="number">32k</span>] [gzip=<span class="number">6</span>] [flush=<span class="number">2m</span>];</span><br><span class="line"><span class="comment">#logtest：日志format，可使用log_format配置的名字来引用</span></span><br><span class="line"><span class="comment">#buffer=32k：缓冲大小32k，32k后才写入文件		方括号表示可选</span></span><br><span class="line"><span class="comment">#flush=2m：若两份钟还没打到缓冲区大小，强制写入文件		方括号表示可选</span></span><br><span class="line"><span class="comment">#gzip=6：将记录的日志信息进行压缩，压缩等级1-9		方括号表示可选</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">open_log_file_cache</span> max=N [inactive=time] [min_uses=N] [valid=time];</span><br><span class="line"><span class="comment">#将日志文件缓存到内存中，减小磁盘的io，最多缓存max=N个日志文件</span></span><br></pre></td></tr></table></figure><p>查看使用gzip的压缩文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd 设置的或默认日志文件目录</span><br><span class="line">cp access.log access.gz</span><br><span class="line">gzip -d access.gz</span><br></pre></td></tr></table></figure><h3 id="errorlog和日志分割"><a href="#errorlog和日志分割" class="headerlink" title="errorlog和日志分割"></a>errorlog和日志分割</h3><p><strong>errorlog</strong></p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/ngx_core_module.html#error_log">http://nginx.org/en/docs/ngx_core_module.html#error_log</a></p><table><thead><tr><th align="left">语法：</th><th><code>error_log file [level];</code></th></tr></thead><tbody><tr><td align="left"><strong>默认：</strong></td><td><strong><code>error_log logs/error.log error;</code></strong></td></tr></tbody></table><p>第二个参数决定日志记录的级别，可以是下列参数之一：debug，info，notice，warn，error，crit，alert，emerg【等级弱-&gt;强】</p><p><strong>日志分割</strong></p><p>1.脚本</p><p>2.Logrotate（CentOS自带）</p><h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><h3 id="upstream被动式重试机制"><a href="#upstream被动式重试机制" class="headerlink" title="upstream被动式重试机制"></a>upstream被动式重试机制</h3><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream</a></p><p>对upstream服务器中所有服务器的限制</p><p><strong>proxy_next_upstream</strong></p><p>设置当连接upstream服务器集群中的某个服务器第一次失败时，指定在哪些情况下将请求传递到下一个服务器</p><p>| 语法: | <code>proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | off ...;</code> |<br>| :——- | ———————————————————— |<br>| Default: | <code>proxy_next_upstream error timeout;</code> |<br>| Context: | <code>http</code>, <code>server</code>, <code>location</code> |</p><p><strong>proxy_next_upstream_timeout</strong></p><p>设置重试的超时时间，超时后不再重试，给用户返回错误，默认为0，即不做限制</p><table><thead><tr><th align="left">语法:</th><th><code>proxy_next_upstream_timeout time;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td><code>proxy_next_upstream_timeout 0;</code></td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><p>**proxy_next_upstream_tries **</p><p>设置重试的最大次数，若超过重试次数，也不再重试，默认为0，即不做限制（proxy_next_upstream_timeout时间内允许proxy_next_upstream_tries次重试，包括第一次）</p><table><thead><tr><th align="left">语法:</th><th><code>proxy_next_upstream_tries number;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td><code>proxy_next_upstream_tries 0;</code></td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><p>示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout;</span><br><span class="line">	<span class="attribute">proxy_next_upstream_timeout</span> <span class="number">15s</span>;</span><br><span class="line">	<span class="attribute">proxy_next_upstream_tries</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>upstream参数</strong></p><p>对upstream中某单一服务器的限制</p><ul><li><strong>max_fails</strong></li></ul><p>最大失败次数</p><p>0为标记一直可用，不检查健康状态</p><ul><li><strong>fail_timeout</strong></li></ul><p>失败时间</p><p>当fail_timeout时间内失败了max_fails次，标记服务不可用</p><p>fail_timeout时间后会再次激活次服务</p><p>示例：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> httpget &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.111.101:8080</span> max_fails=<span class="number">5</span> fail_timeout=<span class="number">10s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.111.102:8080</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="主动健康检查"><a href="#主动健康检查" class="headerlink" title="主动健康检查"></a>主动健康检查</h3><p>tengine版</p><p><a target="_blank" rel="noopener" href="https://github.com/yaoweibin/nginx_upstream_check_module">https://github.com/yaoweibin/nginx_upstream_check_module</a></p><p>nginx商业版</p><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html">http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</a></p><p>补丁包是1.20.1+，和原来的nginx版本不适配，所以重新装一个nginx</p><p><strong>1 下载nginx-1.20.2和nginx_upstream_check_module-0.3.0.tar.gz</strong></p><p>下载后解压</p><p><strong>2 复制check_1.20.1+.patch</strong></p><p>tengine版网页打开，选择check_1.20.1+.patch，复制到linux</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root</span><br><span class="line">vim path	#复制到这里</span><br></pre></td></tr></table></figure><p><strong>3 执行patch修改nginx源码</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.20.2</span><br><span class="line">yum install -y patch</span><br><span class="line">patch -p1 &lt; /root/path</span><br></pre></td></tr></table></figure><p><strong>4 编译新的nginx</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx20 --add-module=/root/nginx_upstream_check_module-0.3.0</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>5 配置</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="section">upstream</span> backend &#123;</span><br><span class="line"></span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.111.101:8080</span>;</span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.111.102:8080</span>;</span><br><span class="line">       <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">           <span class="attribute">check_http_send</span> <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">           <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">	<span class="section">location</span> /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line">            <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">    	 <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">         <span class="attribute">root</span>   html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>6 启动nginx1.20并访问</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx20/sbin/nginx -c /usr/local/nginx20/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>浏览器访问：192.168.111.100&#x2F;status</p><h2 id="Lua基础语法"><a href="#Lua基础语法" class="headerlink" title="Lua基础语法"></a>Lua基础语法</h2><p>用于 nginx二次开发+Openresty</p><p>Lua 是由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组于1993年开发的一种轻量、小巧的脚本语言，用标准 C 语言编写，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p><p>官网：<a target="_blank" rel="noopener" href="http://www.lua.org/">http://www.lua.org/</a></p><p><strong>IDE</strong></p><p>EmmyLua插件</p><p><a target="_blank" rel="noopener" href="https://github.com/EmmyLua/IntelliJ-EmmyLua">https://github.com/EmmyLua/IntelliJ-EmmyLua</a></p><p><a target="_blank" rel="noopener" href="https://emmylua.github.io/zh_CN/">https://emmylua.github.io/zh_CN/</a></p><p><strong>LDT 基于eclipse</strong></p><p><a target="_blank" rel="noopener" href="https://www.eclipse.org/ldt/">https://www.eclipse.org/ldt/</a></p><p><strong>Lua基础语法</strong></p><p><strong>hello world</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello world!&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>保留关键字</strong></p><p><code>and</code> <code>break</code> <code>do</code> <code>else</code> <code>elseif</code> <code>end</code> <code>false</code> <code>for</code> <code>function if</code> <code>in</code> <code>local</code> <code>nil</code> <code>not</code> <code>or</code> <code>repeat</code> <code>return</code> <code>then</code> <code>true</code> <code>until</code> <code>while</code></p><p><strong>注释</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 两个减号是行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 这是块注释.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure><p><strong>变量</strong></p><p><strong>数字类型</strong></p><p>Lua的数字只有double型，64bits</p><p>你可以以如下的方式表示数字</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.0</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">3.1416</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">314.16e-2</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0.31416E1</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">0x56</span></span><br></pre></td></tr></table></figure><p><strong>字符串</strong></p><p>可以用单引号，也可以用双引号</p><p>也可以使用转义字符‘\n’ （换行）， ‘\r’ （回车）， ‘\t’ （横向制表）， ‘\v’ （纵向制表）， ‘\’ （反斜杠）， ‘\”‘ （双引号）， 以及 ‘\” （单引号)等等</p><p>下面的四种方式定义了完全相同的字符串（其中的两个中括号可以用于定义有换行的字符串）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = &#x27;alo\n123&quot;&#x27;</span><br><span class="line"></span><br><span class="line">a = &quot;alo\n123\&quot;&quot;</span><br><span class="line"></span><br><span class="line">a = &#x27;\97lo\10\04923&quot;&#x27;</span><br><span class="line"></span><br><span class="line">a = [[alo</span><br><span class="line"></span><br><span class="line">123&quot;]]</span><br></pre></td></tr></table></figure><p><strong>空值</strong></p><p>C语言中的NULL在Lua中是nil，比如你访问一个没有声明过的变量，就是nil</p><p><strong>布尔类型</strong></p><p>只有nil和false是 false</p><p>数字0，‘’空字符串（’\0’）都是true</p><p><strong>作用域</strong></p><p>lua中的变量如果没有特殊说明，全是全局变量，那怕是语句块或是函数里。</p><p>变量前加local关键字的是局部变量。</p><p><strong>控制语句</strong></p><p><strong>while循环</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">max</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> i &lt;= <span class="built_in">max</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">i = i +<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>if-else</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> age = <span class="number">140</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> sex = <span class="string">&#x27;Male&#x27;</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> age == <span class="number">40</span> <span class="keyword">and</span> sex ==<span class="string">&quot;Male&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 男人四十一枝花 &quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &gt; <span class="number">60</span> <span class="keyword">and</span> sex ~=<span class="string">&quot;Female&quot;</span> <span class="keyword">then</span></span><br><span class="line">   </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;old man!!&quot;</span>)</span><br><span class="line">  <span class="keyword">elseif</span> age &lt; <span class="number">20</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;too young, too simple!\n&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Your age is &quot;</span>..age)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>for循环</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">100</span>, <span class="number">1</span>, <span class="number">-2</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">	sum = sum + i</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>函数</strong></p><ol><li></li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myPower</span><span class="params">(x,y)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>      y+x</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">power2 = myPower(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"> <span class="built_in">print</span>(power2)</span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newCounter</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span>     <span class="comment">-- anonymous function</span></span><br><span class="line"></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">c1 = newCounter()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1())</span><br></pre></td></tr></table></figure><p><strong>返回值</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name, age,bGay = <span class="string">&quot;yiming&quot;</span>, <span class="number">37</span>, <span class="literal">false</span>, <span class="string">&quot;yimingl@hotmail.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,age,bGay)</span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMyGirl</span><span class="params">(name)</span></span></span><br><span class="line">  <span class="keyword">return</span> name == <span class="string">&#x27;xiao6&#x27;</span> , name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> bol,name = isMyGirl(<span class="string">&#x27;xiao6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(name,bol)</span><br></pre></td></tr></table></figure><p><strong>Table</strong></p><p>key，value的键值对 类似 map</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">dog = &#123;name=<span class="string">&#x27;111&#x27;</span>,age=<span class="number">18</span>,height=<span class="number">165.5</span>&#125;</span><br><span class="line"></span><br><span class="line">dog.age=<span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog.name,dog.age,dog.height)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dog)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p><strong>数组</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(arr[<span class="number">4</span>]())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>遍历</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arr = &#123;<span class="string">&quot;string&quot;</span>, <span class="number">100</span>, <span class="string">&quot;dog&quot;</span>,<span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;wangwang!&quot;</span>) <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(arr) <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">print</span>(k, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>成员函数</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">person = &#123;name=<span class="string">&#x27;旺财&#x27;</span>,age = <span class="number">18</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>  <span class="title">person.eat</span><span class="params">(food)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(person.name ..<span class="string">&quot; eating &quot;</span>..food)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">person.eat(<span class="string">&quot;骨头&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Openresty-Nginx-Lua"><a href="#Openresty-Nginx-Lua" class="headerlink" title="Openresty Nginx + Lua"></a>Openresty Nginx + Lua</h2><p>Nginx是一个主进程配合多个工作进程的工作模式，每个进程由单个线程来处理多个连接。</p><p>在生产环境中，我们往往会把cpu内核直接绑定到工作进程上，从而提升性能。</p><h3 id="安装启动"><a href="#安装启动" class="headerlink" title="安装启动"></a>安装启动</h3><p><strong>预编译安装</strong></p><p>以CentOS举例 其他系统参照：<a target="_blank" rel="noopener" href="http://openresty.org/cn/linux-packages.html">http://openresty.org/cn/linux-packages.html</a></p><p>你可以在你的 CentOS 系统中添加 openresty 仓库，这样就可以便于未来安装或更新我们的软件包（通过 yum update 命令）。运行下面的命令就可以添加我们的仓库：</p><p> yum install yum-utils</p><p> yum-config-manager –add-repo <a target="_blank" rel="noopener" href="https://openresty.org/package/centos/openresty.repo">https://openresty.org/package/centos/openresty.repo</a></p><p>然后就可以像下面这样安装软件包，比如 openresty：</p><p> yum install openresty</p><p>如果你想安装命令行工具 resty，那么可以像下面这样安装 openresty-resty 包：</p><p> sudo yum install openresty-resty</p><p><strong>源码编译安装</strong></p><p><strong>下载</strong></p><p><a target="_blank" rel="noopener" href="http://openresty.org/cn/download.html">http://openresty.org/cn/download.html</a></p><p>最小版本基于nginx1.21</p><p>然后在进入 <code>openresty-VERSION/</code>目录, 然后输入以下命令配置:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/openresty</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>默认, <code>--prefix=/usr/local/openresty</code> 程序会被安装到<code>/usr/local/openresty</code>目录。</p><p>依赖 <code>gcc openssl-devel pcre-devel zlib-devel</code></p><p>安装：<code>yum install gcc openssl-devel pcre-devel zlib-devel postgresql-devel</code></p><p>您可以指定各种选项，比如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/openresty \</span><br><span class="line"></span><br><span class="line">            --with-luajit \</span><br><span class="line"></span><br><span class="line">            --without-http_redis2_module \</span><br><span class="line"></span><br><span class="line">            --with-http_iconv_module \</span><br><span class="line"></span><br><span class="line">            --with-http_postgres_module</span><br></pre></td></tr></table></figure><p>试着使用 <code>./configure --help</code> 查看更多的选项。</p><p><code>make &amp;&amp; make install</code></p><p><strong>启动</strong></p><p><code>Service openresty start</code></p><p>或</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/nginx/sbin</span><br><span class="line">./nginx -c /usr/local/openresty/nginx/conf/nginx.conf	#启动前修改配置文件端口号以防和原nginx冲突</span><br></pre></td></tr></table></figure><p><strong>停止</strong></p><p><code>Service openresty stop</code></p><p><strong>检查配置文件是否正确</strong></p><p><code>Nginx -t</code></p><p>重新加载配置文件</p><p><code>Service openresty reload</code></p><p><strong>查看已安装模块和版本号</strong></p><p><code>Nginx -V</code></p><p><strong>测试lua脚本</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在Nginx.conf 中写入</span></span><br><span class="line"><span class="section">location</span> /lua &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">default_type</span> text/html;</span><br><span class="line">     <span class="attribute">content_by_lua</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">        ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</span></span><br><span class="line"><span class="string">      &#x27;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>不在配置文件写lua，引入lua文件：nginx目录下的lua&#x2F;hello.lua</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">content_by_lua_file</span> lua/hello.lua;</span><br></pre></td></tr></table></figure><h3 id="lua-nginx-module"><a href="#lua-nginx-module" class="headerlink" title="lua-nginx-module"></a>lua-nginx-module</h3><h4 id="引入lua环境"><a href="#引入lua环境" class="headerlink" title="引入lua环境"></a>引入lua环境</h4><p><strong>创建配置文件lua.conf（没必要采用引入方式，直接在nginx配置文件中写location &#x2F;lua 即可）</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">   <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">   <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">   <span class="section">location</span> /lua &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">content_by_lua_file</span> lua/hello.lua;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在Nginx.conf下引入lua配置</strong></p><p><code>include lua.conf;</code></p><p><strong>创建外部lua脚本</strong></p><p><code>nginx目录下的lua/hello.lua</code></p><p>内容：</p><p><code>ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)</code></p><p><strong>代码热部署</strong></p><p>关闭缓存，开启热部署，不用每次都重启openresty nginx</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_code_cache off;</span><br></pre></td></tr></table></figure><h4 id="用lua代码获取各值"><a href="#用lua代码获取各值" class="headerlink" title="用lua代码获取各值"></a>用lua代码获取各值</h4><p><strong>获取Nginx uri中的单一变量</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /nginx_var &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attribute">default_type</span> text/html;</span><br><span class="line">      <span class="section">content_by_lua_block</span> &#123;</span><br><span class="line">      		ngx.say(ngx.var.arg_a)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>获取Nginx uri中的所有变量</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> uri_args = ngx.req.get_uri_args()  </span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(uri_args) <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;, &quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line">        ngx.say(k, <span class="string">&quot;: &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>在处理http请求时还可以使用</strong></p><ul><li>set_by_lua</li></ul><p>修改nginx变量</p><ul><li>rewrite_by_lua</li></ul><p>修改uri</p><ul><li>access_by_lua</li></ul><p>访问控制</p><ul><li>header_filter_by_lua</li></ul><p>修改响应头</p><ul><li>boy_filter_by_lua</li></ul><p>修改响应体</p><ul><li>log_by_lua</li></ul><p>日志</p><p><strong>获取Nginx请求头信息</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> headers = ngx.req.get_headers()                         </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;Host : &quot;</span>, headers[<span class="string">&quot;Host&quot;</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;user-agent : &quot;</span>, headers[<span class="string">&quot;user-agent&quot;</span>], <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;user-agent : &quot;</span>, headers.user_agent, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(headers) <span class="keyword">do</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;,&quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure><p><strong>获取post请求参数</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ngx.req.read_body()  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;post args begin&quot;</span>, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> post_args = ngx.req.get_post_args()  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(post_args) <span class="keyword">do</span>  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot; : &quot;</span>, <span class="built_in">table</span>.<span class="built_in">concat</span>(v, <span class="string">&quot;, &quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line"></span><br><span class="line">        ngx.say(k, <span class="string">&quot;: &quot;</span>, v, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>http协议版本</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.http_version : &quot;</span>, ngx.req.http_version(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>请求方法</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.get_method : &quot;</span>, ngx.req.get_method(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br></pre></td></tr></table></figure><p><strong>原始的请求头内容</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.raw_header : &quot;</span>,  ngx.req.raw_header(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br></pre></td></tr></table></figure><p><strong>body内容体</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx.say(<span class="string">&quot;ngx.req.get_body_data() : &quot;</span>, ngx.req.get_body_data(), <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="Nginx缓存"><a href="#Nginx缓存" class="headerlink" title="Nginx缓存"></a>Nginx缓存</h3><h4 id="Nginx全局内存缓存"><a href="#Nginx全局内存缓存" class="headerlink" title="Nginx全局内存缓存"></a>Nginx全局内存缓存</h4><p>nginx配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">lua_shared_dict</span> shared_data <span class="number">1m</span>;		<span class="comment">#http中</span></span><br></pre></td></tr></table></figure><p>lua文件代码：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> shared_data = ngx.shared.shared_data  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> i = shared_data:get(<span class="string">&quot;i&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> i <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">    i = <span class="number">1</span>  </span><br><span class="line"></span><br><span class="line">    shared_data:set(<span class="string">&quot;i&quot;</span>, i)  </span><br><span class="line"></span><br><span class="line">    ngx.say(<span class="string">&quot;lazy set i &quot;</span>, i, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">i = shared_data:incr(<span class="string">&quot;i&quot;</span>, <span class="number">1</span>)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;i=&quot;</span>, i, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="lua-resty-lrucache"><a href="#lua-resty-lrucache" class="headerlink" title="lua-resty-lrucache"></a>lua-resty-lrucache</h4><p>Lua 实现的一个简单的 LRU 缓存，适合在 Lua 空间里直接缓存较为复杂的 Lua 数据结构：它相比 ngx_lua 共享内存字典可以省去较昂贵的序列化操作，相比 memcached 这样的外部服务又能省去较昂贵的 socket 操作</p><p><a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-lrucache">https://github.com/openresty/lua-resty-lrucache</a></p><p>新建文件cache.lua</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/lualib</span><br><span class="line">mkdir my</span><br><span class="line">cd my</span><br><span class="line">vim cache.lua	#内容写下面lua文件代码</span><br></pre></td></tr></table></figure><p>lua文件代码：自定义函数</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line">lrucache = <span class="built_in">require</span> <span class="string">&quot;resty.lrucache&quot;</span></span><br><span class="line"></span><br><span class="line">c, err = lrucache.new(<span class="number">200</span>)  <span class="comment">-- allow up to 200 items in the cache</span></span><br><span class="line">ngx.say(<span class="string">&quot;count=init&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">error</span>(<span class="string">&quot;failed to create the cache: &quot;</span> .. (err <span class="keyword">or</span> <span class="string">&quot;unknown&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.go</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">count = c:get(<span class="string">&quot;count&quot;</span>)</span><br><span class="line"></span><br><span class="line">c:set(<span class="string">&quot;count&quot;</span>,<span class="number">100</span>)</span><br><span class="line">ngx.say(<span class="string">&quot;count=&quot;</span>, count, <span class="string">&quot; --&lt;br/&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> count <span class="keyword">then</span>  </span><br><span class="line"></span><br><span class="line">    c:set(<span class="string">&quot;count&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    ngx.say(<span class="string">&quot;lazy set count &quot;</span>, c:get(<span class="string">&quot;count&quot;</span>), <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">c:set(<span class="string">&quot;count&quot;</span>,count+<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">ngx.say(<span class="string">&quot;count=&quot;</span>, count, <span class="string">&quot;&lt;br/&gt;&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure><p>nginx配置文件引用lua文件</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释掉http中的代码热部署，否则lua文件中每次都会new一个新对象</span></span><br><span class="line"><span class="comment">#lua_code_cache off;</span></span><br><span class="line"><span class="attribute">lua_shared_dict</span> shared_data <span class="number">1m</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /lua &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">#content_by_lua_file lua/hello.lua;		#需注释，否则与lua_block冲突</span></span><br><span class="line">        </span><br><span class="line">    <span class="section">content_by_lua_block</span> &#123;</span><br><span class="line">    	require(&quot;my/cache&quot;).go()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lua-resty-redis访问redis"><a href="#lua-resty-redis访问redis" class="headerlink" title="lua-resty-redis访问redis"></a>lua-resty-redis访问redis</h3><p><font color="cornflowerblue">nginx连接redis或者mysql用于直接从nginx获取redis、mysql中的数据，简化从tomcat让tomcat连接数据库再传值回来，数据库中的值的写入由tomcat完成，nginx只需要读取就好</font></p><p><a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-redis">https://github.com/openresty/lua-resty-redis</a></p><p>除了lua-resty-redis可以连接redis，也可以用前面讲的redis2-nginx-module</p><p><strong>常用方法</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> res, err = red:get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res, err = red:lrange(<span class="string">&quot;nokey&quot;</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;res:&quot;</span>,cjson.encode(res))</span><br></pre></td></tr></table></figure><p><strong>创建连接</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">red, err = redis:new()</span><br><span class="line"></span><br><span class="line">ok, err = red:connect(host, port, options_table?)</span><br></pre></td></tr></table></figure><p><strong>timeout</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">red:set_timeout(<span class="built_in">time</span>)</span><br></pre></td></tr></table></figure><p><strong>keepalive</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">red:set_keepalive(max_idle_timeout, pool_size)</span><br></pre></td></tr></table></figure><p><strong>close</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = red:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure><p><strong>pipeline</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">red:init_pipeline()</span><br><span class="line"></span><br><span class="line">results, err = red:commit_pipeline()</span><br></pre></td></tr></table></figure><p><strong>认证</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">local</span> res, err = red:auth(<span class="string">&quot;foobared&quot;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">       ngx.say(<span class="string">&quot;failed to authenticate: &quot;</span>, err)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>nginx配置</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content_by_lua_file lua/redis.lua</span><br></pre></td></tr></table></figure><p><strong>redis.lua</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">		<span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&quot;resty.redis&quot;</span></span><br><span class="line">            <span class="keyword">local</span> red = redis:new()</span><br><span class="line"></span><br><span class="line">            red:set_timeouts(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1000</span>) <span class="comment">-- 1 sec</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">local</span> ok, err = red:connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;failed to connect: &quot;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">red:auth(<span class="string">&quot;123123&quot;</span>) 		<span class="comment">--redis有密码需要输入密码，没密码删除此行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--业务代码，根据实际情况修改</span></span><br><span class="line">            ok, err = red:set(<span class="string">&quot;dog&quot;</span>, <span class="string">&quot;an animal&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;failed to set dog: &quot;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            ngx.say(<span class="string">&quot;set result: &quot;</span>, ok)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">local</span> res, err = red:get(<span class="string">&quot;dog&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;failed to get dog: &quot;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> res == ngx.null <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;dog not found.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ngx.say(<span class="string">&quot;dog: &quot;</span>, res)</span><br></pre></td></tr></table></figure><p><strong>redis-cluster支持</strong></p><p><a target="_blank" rel="noopener" href="https://github.com/steve0511/resty-redis-cluster">https://github.com/steve0511/resty-redis-cluster</a></p><h3 id="redis2-nginx-module"><a href="#redis2-nginx-module" class="headerlink" title="redis2-nginx-module"></a>redis2-nginx-module</h3><p>redis2-nginx-module是一个支持 Redis 2.0 协议的 Nginx upstream 模块，它可以让 Nginx 以非阻塞方式直接防问远方的 Redis 服务，同时支持 TCP 协议和 Unix Domain Socket 模式，并且可以启用强大的 Redis 连接池功能。</p><p><strong>test</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /foo &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>get</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> = /get &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>set</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /set?key=one&amp;val=first%20value</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /set &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_pass</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> auth <span class="number">123123</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$key</span> <span class="variable">$arg_key</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">set_unescape_uri</span> <span class="variable">$val</span> <span class="variable">$arg_val</span>;  <span class="comment"># this requires ngx_set_misc</span></span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set <span class="variable">$key</span> <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>pipeline</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">     <span class="attribute">set</span> <span class="variable">$value</span> <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one <span class="variable">$value</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> set one two;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">redis2_query</span> get one;</span><br><span class="line"></span><br><span class="line"><span class="attribute">redis2_query</span> del key1;</span><br></pre></td></tr></table></figure><p><strong>list</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    redis2_query lpush key1 C;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 B;</span><br><span class="line"></span><br><span class="line">    redis2_query lpush key1 A;</span><br><span class="line"></span><br><span class="line">redis2_query lrange key1 <span class="number">0</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure><hr><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> redis_cluster &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.199.161:6379</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> = /redis &#123;</span><br><span class="line"></span><br><span class="line"><span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_next_upstream</span> <span class="literal">error</span> timeout invalid_response;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_query</span> get foo;</span><br><span class="line"></span><br><span class="line">         <span class="attribute">redis2_pass</span> redis_cluster;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="lua-resty-mysql"><a href="#lua-resty-mysql" class="headerlink" title="lua-resty-mysql"></a>lua-resty-mysql</h3><p><font color="cornflowerblue">nginx连接redis或者mysql用于直接从nginx获取redis、mysql中的数据，简化从tomcat让tomcat连接数据库再传值回来，数据库中的值的写入由tomcat完成，nginx只需要读取就好</font></p><p><a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-mysql">https://github.com/openresty/lua-resty-mysql</a></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span> <span class="string">&quot;resty.mysql&quot;</span></span><br><span class="line">            <span class="keyword">local</span> db, err = mysql:new()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;failed to instantiate mysql: &quot;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">            db:set_timeout(<span class="number">1000</span>) <span class="comment">-- 1 sec</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">--自己的mysql信息</span></span><br><span class="line">            <span class="keyword">local</span> ok, err, errcode, sqlstate = db:connect&#123;</span><br><span class="line">                host = <span class="string">&quot;192.168.111.100&quot;</span>,</span><br><span class="line">                port = <span class="number">3306</span>,</span><br><span class="line">                database = <span class="string">&quot;zhangmen&quot;</span>,</span><br><span class="line">                user = <span class="string">&quot;root&quot;</span>,</span><br><span class="line">                password = <span class="string">&quot;123456&quot;</span>,</span><br><span class="line">                charset = <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">                max_packet_size = <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            ngx.say(<span class="string">&quot;connected to mysql.&lt;br&gt;&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">--业务代码，根据实际情况修改</span></span><br><span class="line">            <span class="keyword">local</span> res, err, errcode, sqlstate = db:query(<span class="string">&quot;drop table if exists cats&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;bad result: &quot;</span>, err, <span class="string">&quot;: &quot;</span>, errcode, <span class="string">&quot;: &quot;</span>, sqlstate, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            res, err, errcode, sqlstate =</span><br><span class="line">                db:query(<span class="string">&quot;create table cats &quot;</span></span><br><span class="line">                         .. <span class="string">&quot;(id serial primary key, &quot;</span></span><br><span class="line">                         .. <span class="string">&quot;name varchar(5))&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;bad result: &quot;</span>, err, <span class="string">&quot;: &quot;</span>, errcode, <span class="string">&quot;: &quot;</span>, sqlstate, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">            ngx.say(<span class="string">&quot;table cats created.&lt;br&gt;&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            res, err, errcode, sqlstate =</span><br><span class="line">                db:query(<span class="string">&quot;select * from t_emp&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;bad result: &quot;</span>, err, <span class="string">&quot;: &quot;</span>, errcode, <span class="string">&quot;: &quot;</span>, sqlstate, <span class="string">&quot;.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span></span><br><span class="line">            ngx.say(<span class="string">&quot;result: &quot;</span>, cjson.encode(res))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            <span class="keyword">local</span> ok, err = db:set_keepalive(<span class="number">10000</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.say(<span class="string">&quot;failed to set keepalive: &quot;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="模板实时渲染-lua-resty-template"><a href="#模板实时渲染-lua-resty-template" class="headerlink" title="模板实时渲染 lua-resty-template"></a>模板实时渲染 lua-resty-template</h2><p><a target="_blank" rel="noopener" href="https://github.com/bungle/lua-resty-template">https://github.com/bungle/lua-resty-template</a></p><p>如果学习过JavaEE中的servlet和JSP的话，应该知道JSP模板最终会被翻译成Servlet来执行；</p><p>而lua-resty-template模板引擎可以认为是JSP，其最终会被翻译成Lua代码，然后通过ngx.print输出。</p><p>lua-resty-template大体内容有：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">l   模板位置：从哪里查找模板； </span><br><span class="line"></span><br><span class="line">l   变量输出/转义：变量值输出； </span><br><span class="line"></span><br><span class="line">l   代码片段：执行代码片段，完成如if/else、for等复杂逻辑，调用对象函数/方法； </span><br><span class="line"></span><br><span class="line">l   注释：解释代码片段含义； </span><br><span class="line"></span><br><span class="line">l   include：包含另一个模板片段； </span><br><span class="line"></span><br><span class="line">l   其他：lua-resty-template还提供了不需要解析片段、简单布局、可复用的代码块、宏指令等支持。</span><br><span class="line"></span><br><span class="line">基础语法</span><br><span class="line"></span><br><span class="line">l   &#123;(include_file)&#125;：包含另一个模板文件；</span><br><span class="line"></span><br><span class="line">l   &#123;* var *&#125;：变量输出；</span><br><span class="line"></span><br><span class="line">l   &#123;&#123; var &#125;&#125;：变量转义输出；</span><br><span class="line"></span><br><span class="line">l   &#123;% code %&#125;：代码片段；</span><br><span class="line"></span><br><span class="line">l   &#123;# comment #&#125;：注释；</span><br><span class="line"></span><br><span class="line">l   &#123;-raw-&#125;：中间的内容不会解析，作为纯文本输出；</span><br></pre></td></tr></table></figure><h3 id="准备和简单测试"><a href="#准备和简单测试" class="headerlink" title="准备和简单测试"></a>准备和简单测试</h3><p><strong>解压移动模板引擎到openresty&#x2F;resty目录下</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/lualib</span><br><span class="line"></span><br><span class="line">上传下载好的 lua-resty-template-2.0.tar.gz</span><br><span class="line">tar -zxvf lua-resty-template-2.0.tar.gz</span><br><span class="line">cd lua-resty-template-2.0/lib/resty</span><br><span class="line">mv template/ template.lua /usr/local/openresty/lualib/resty</span><br></pre></td></tr></table></figure><p><strong>写模板</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty</span><br><span class="line">mkdir tpl</span><br><span class="line">cd tpl</span><br><span class="line">vim view.html	#新建模板</span><br></pre></td></tr></table></figure><p>view.html内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>nginx.conf中配置</strong></p><p>lua代码热加载</p><p>在http模块中加入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_code_cache off;</span><br></pre></td></tr></table></figure><p>reload后Nginx会提示影响性能，记得在生产环境中关掉。</p><p>配置模板文件存放位置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /lua &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="attribute">set</span> <span class="variable">$template_root</span> /usr/local/openresty/tpl;</span><br><span class="line">    <span class="attribute">content_by_lua_file</span> lua/tpl.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>写lua文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/nginx/lua</span><br><span class="line">vim tpl.lua</span><br></pre></td></tr></table></figure><p>tpl.lua内容：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Using template.new</span></span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span> <span class="string">&quot;resty.template&quot;</span></span><br><span class="line"><span class="keyword">local</span> view = template.new <span class="string">&quot;view.html&quot;</span>	<span class="comment">--读取前面写的模板view.html</span></span><br><span class="line">view.message = <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line">view:render()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Using template.render</span></span><br><span class="line"><span class="comment">-- template.render(&quot;view.html&quot;, &#123; message = &quot;Hel11lo, Worl1d!&quot; &#125;)</span></span><br></pre></td></tr></table></figure><p><strong>重启openresty nginx</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/nginx/sbin/</span><br><span class="line">./nginx -s stop</span><br><span class="line">./nginx -c /usr/local/openresty/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><h3 id="其他测试配置"><a href="#其他测试配置" class="headerlink" title="其他测试配置"></a>其他测试配置</h3><p><strong>一、初始化</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- Using template.new</span><br><span class="line">local template = require &quot;resty.template&quot;</span><br><span class="line">local view = template.new &quot;view.html&quot;</span><br><span class="line">view.message = &quot;Hello, World!&quot;</span><br><span class="line">view:render()</span><br><span class="line"></span><br><span class="line">-- Using template.render</span><br><span class="line">-- template.render(&quot;view.html&quot;, &#123; message = &quot;Hel11lo, Worl1d!&quot; &#125;)</span><br></pre></td></tr></table></figure><p><strong>二、执行函数，得到渲染之后的内容</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">local func = template.compile(&quot;view.html&quot;)  </span><br><span class="line"></span><br><span class="line">local content = func(context)  </span><br><span class="line"></span><br><span class="line">ngx.say(&quot;xx:&quot;,content) </span><br></pre></td></tr></table></figure><p><strong>resty.template.html</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> html = <span class="built_in">require</span> <span class="string">&quot;resty.template.html&quot;</span></span><br><span class="line"></span><br><span class="line">template.render(<span class="string">[[</span></span><br><span class="line"><span class="string">&lt;ul&gt;</span></span><br><span class="line"><span class="string">&#123;% for _, person in ipairs(context) do %&#125;</span></span><br><span class="line"><span class="string">    &#123;*html.li(person.name)*&#125; --</span></span><br><span class="line"><span class="string">&#123;% end %&#125;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;table&gt;</span></span><br><span class="line"><span class="string">&#123;% for _, person in ipairs(context) do %&#125;</span></span><br><span class="line"><span class="string">    &lt;tr data-sort=&quot;&#123;&#123;(person.name or &quot;&quot;):lower()&#125;&#125;&quot;&gt;</span></span><br><span class="line"><span class="string">        &#123;*html.td&#123; id = person.id &#125;(person.name)*&#125;</span></span><br><span class="line"><span class="string">    &lt;/tr&gt;</span></span><br><span class="line"><span class="string">&#123;% end %&#125;</span></span><br><span class="line"><span class="string">&lt;/table&gt;]]</span>, &#123;</span><br><span class="line">    &#123; id = <span class="number">1</span>, name = <span class="string">&quot;Emma&quot;</span>&#125;,</span><br><span class="line">    &#123; id = <span class="number">2</span>, name = <span class="string">&quot;James&quot;</span> &#125;,</span><br><span class="line">    &#123; id = <span class="number">3</span>, name = <span class="string">&quot;Nicholas&quot;</span> &#125;,</span><br><span class="line">    &#123; id = <span class="number">4</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>模板内容</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>多值传入</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">template.caching(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">    name = <span class="string">&quot;lucy&quot;</span>,</span><br><span class="line">    age = <span class="number">50</span>,</span><br><span class="line">&#125;</span><br><span class="line">template.render(<span class="string">&quot;view.html&quot;</span>, context)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>模板内容</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;h1&gt;name:&#123;&#123;name&#125;&#125;&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;age:&#123;&#123;age&#125;&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>模板管理与缓存</strong></p><p>模板缓存：默认开启，开发环境可以手动关闭</p><p><code>template.caching(true)</code></p><p>模板文件需要业务系统更新与维护，当模板文件更新后，可以通过模板版本号或消息通知Openresty清空缓存重载模板到内存中</p><p><code>template.cache = &#123;&#125;</code></p><h3 id="完整配置示例"><a href="#完整配置示例" class="headerlink" title="完整配置示例"></a>完整配置示例</h3><p><strong>完整页面</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)</span><br><span class="line">template.caching(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">local</span> context = &#123;</span><br><span class="line">    title = <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">    name = <span class="string">&quot;lucy&quot;</span>,</span><br><span class="line">    description = <span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>,</span><br><span class="line">    age = <span class="number">40</span>,</span><br><span class="line">    hobby = &#123;<span class="string">&quot;电影&quot;</span>, <span class="string">&quot;音乐&quot;</span>, <span class="string">&quot;阅读&quot;</span>&#125;,</span><br><span class="line">    score = &#123;语文 = <span class="number">90</span>, 数学 = <span class="number">80</span>, 英语 = <span class="number">70</span>&#125;,</span><br><span class="line">    score2 = &#123;</span><br><span class="line">        &#123;name = <span class="string">&quot;语文&quot;</span>, score = <span class="number">90</span>&#125;,</span><br><span class="line">        &#123;name = <span class="string">&quot;数学&quot;</span>, score = <span class="number">80</span>&#125;,</span><br><span class="line">        &#123;name = <span class="string">&quot;英语&quot;</span>, score = <span class="number">70</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">template.render(<span class="string">&quot;view.html&quot;</span>, context)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>模板</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;(header.html)&#125;  	<span class="comment">&lt;!--引入页面，自己随便写一个，再view.html同目录--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">      &#123;# 不转义变量输出 #&#125;  </span><br><span class="line">      姓名：&#123;* string.upper(name) *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      &#123;# 转义变量输出 #&#125;  </span><br><span class="line">      简介：&#123;&#123;description&#125;&#125;</span><br><span class="line">           简介：&#123;* description *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      &#123;# 可以做一些运算 #&#125;  </span><br><span class="line">      年龄: &#123;* age + 10 *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      &#123;# 循环输出 #&#125;  </span><br><span class="line">      爱好：  </span><br><span class="line">      &#123;% for i, v in ipairs(hobby) do %&#125;  </span><br><span class="line">         &#123;% if v == &#x27;电影&#x27; then  %&#125; - xxoo</span><br><span class="line">            </span><br><span class="line">              &#123;%else%&#125;  - &#123;* v *&#125; </span><br><span class="line">&#123;% end %&#125;  </span><br><span class="line">         </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">      成绩：  </span><br><span class="line">      &#123;% local i = 1; %&#125;  </span><br><span class="line">      &#123;% for k, v in pairs(score) do %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">         &#123;* k *&#125; = &#123;* v *&#125;  </span><br><span class="line">         &#123;% i = i + 1 %&#125;  </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      成绩2：  </span><br><span class="line">      &#123;% for i = 1, #score2 do local t = score2[i] %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">          &#123;* t.name *&#125; = &#123;* t.score *&#125;  </span><br><span class="line">      &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">      &#123;# 中间内容不解析 #&#125;  </span><br><span class="line">      &#123;-raw-&#125;&#123;(file)&#125;&#123;-raw-&#125;  </span><br><span class="line">&#123;(footer.html)&#125;  <span class="comment">&lt;!--引入页面，自己随便写一个，再view.html同目录--&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="layout-布局统一风格"><a href="#layout-布局统一风格" class="headerlink" title="layout 布局统一风格"></a>layout 布局统一风格</h3><p>使用模板内容嵌套可以实现全站风格同一布局</p><p><strong>lua</strong></p><p><code>local template = require &quot;resty.template&quot;</code></p><p>一、</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local layout   = template.new &quot;layout.html&quot;</span><br><span class="line"></span><br><span class="line">layout.title   = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">layout.view    = template.compile &quot;view.html&quot; &#123; message = &quot;Hello, World!&quot; &#125;</span><br><span class="line"></span><br><span class="line">layout:render()</span><br></pre></td></tr></table></figure><p>二、</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">template.render(&quot;layout.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">  title = &quot;Testing lua-resty-template&quot;,</span><br><span class="line"></span><br><span class="line">  msg = &quot;type=2&quot;,</span><br><span class="line"></span><br><span class="line">  view  = template.compile &quot;view.html&quot; &#123; message = &quot;Hello, World!&quot; &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>三、</p><p>此方式重名变量值会被覆盖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">local view     = template.new(&quot;view.html&quot;, &quot;layout.html&quot;)</span><br><span class="line"></span><br><span class="line">view.title     = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">view.msg = &quot;type=3&quot;</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br></pre></td></tr></table></figure><p>四、</p><p>可以区分一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">local layout   = template.new &quot;layout.html&quot;</span><br><span class="line"></span><br><span class="line">layout.title   = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">layout.msg = &quot;type=4&quot;</span><br><span class="line"></span><br><span class="line">local view     = template.new(&quot;view.html&quot;, layout)</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br></pre></td></tr></table></figure><p><strong>layout.html</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line">​    &lt;title&gt;&#123;&#123;title&#125;&#125;&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;layout&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">​    &#123;*view*&#125;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><strong>view.html·</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`msg:&#123;&#123;message&#125;&#125;`</span><br></pre></td></tr></table></figure><p><strong>多级嵌套</strong></p><p>lua</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">local view     = template.new(&quot;view.html&quot;, &quot;layout.html&quot;)</span><br><span class="line"></span><br><span class="line">view.title     = &quot;Testing lua-resty-template&quot;</span><br><span class="line"></span><br><span class="line">view.message   = &quot;Hello, World!&quot;</span><br><span class="line"></span><br><span class="line">view:render()</span><br><span class="line"></span><br><span class="line">view.html</span><br><span class="line"></span><br><span class="line">&#123;% layout=&quot;section.html&quot; %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h&gt;msg:&#123;&#123;message&#125;&#125;&lt;/h&gt;</span><br></pre></td></tr></table></figure><p>section.html</p><div id="section"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    &#123;*view*&#125; - sss</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>layout.html</p><!DOCTYPE html><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">​    &lt;title&gt;&#123;&#123;title&#125;&#125;&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;h&gt;layout &#123;&#123;msg&#125;&#125;&lt;/h&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">​    &#123;*view*&#125;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="Redis缓存-mysql-模板输出"><a href="#Redis缓存-mysql-模板输出" class="headerlink" title="Redis缓存+mysql+模板输出"></a>Redis缓存+mysql+模板输出</h3><p>lua</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">  cjson = require &quot;cjson&quot;</span><br><span class="line">sql=&quot;select * from t_emp&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local redis = require &quot;resty.redis&quot;</span><br><span class="line">                local red = redis:new()</span><br><span class="line"></span><br><span class="line">                red:set_timeouts(1000, 1000, 1000) -- 1 sec</span><br><span class="line"></span><br><span class="line">  local ok, err = red:connect(&quot;127.0.0.1&quot;, 6379)</span><br><span class="line"> if not ok then</span><br><span class="line">                    ngx.say(&quot;failed to connect: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">                local res, err = red:get(sql)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;failed to get sql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                if res == ngx.null then</span><br><span class="line">                    ngx.say(&quot;sql&quot;..sql..&quot; not found.&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--mysql查询</span><br><span class="line">local mysql = require &quot;resty.mysql&quot;</span><br><span class="line">                local db, err = mysql:new()</span><br><span class="line">                if not db then</span><br><span class="line">                    ngx.say(&quot;failed to instantiate mysql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                db:set_timeout(1000) -- 1 sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                local ok, err, errcode, sqlstate = db:connect&#123;</span><br><span class="line">                    host = &quot;192.168.44.211&quot;,</span><br><span class="line">                    port = 3306,</span><br><span class="line">                    database = &quot;zhangmen&quot;,</span><br><span class="line">                    user = &quot;root&quot;,</span><br><span class="line">                    password = &quot;111111&quot;,</span><br><span class="line">                    charset = &quot;utf8&quot;,</span><br><span class="line">                    max_packet_size = 1024 * 1024,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;connected to mysql.&lt;br&gt;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> res, err, errcode, sqlstate =</span><br><span class="line">                    db:query(sql)</span><br><span class="line">                if not res then</span><br><span class="line">                    ngx.say(&quot;bad result: &quot;, err, &quot;: &quot;, errcode, &quot;: &quot;, sqlstate, &quot;.&quot;)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          --ngx.say(&quot;result: &quot;, cjson.encode(res))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      ok, err = red:set(sql, cjson.encode(res))</span><br><span class="line">                if not ok then</span><br><span class="line">                    ngx.say(&quot;failed to set sql: &quot;, err)</span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line">                ngx.say(&quot;set result: &quot;, ok)</span><br><span class="line"></span><br><span class="line">                    return</span><br><span class="line">                end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local template = require(&quot;resty.template&quot;)</span><br><span class="line">template.caching(false)</span><br><span class="line">local context = &#123;</span><br><span class="line">    title = &quot;测试&quot;,</span><br><span class="line">    name = &quot;lucy&quot;,</span><br><span class="line">    description = &quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;,</span><br><span class="line">    age = 40,</span><br><span class="line">    hobby = &#123;&quot;电影&quot;, &quot;音乐&quot;, &quot;阅读&quot;&#125;,</span><br><span class="line">    score = &#123;语文 = 90, 数学 = 80, 英语 = 70&#125;,</span><br><span class="line">    score2 = &#123;</span><br><span class="line">        &#123;name = &quot;语文&quot;, score = 90&#125;,</span><br><span class="line">        &#123;name = &quot;数学&quot;, score = 80&#125;,</span><br><span class="line">        &#123;name = &quot;英语&quot;, score = 70&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">zhangmen=cjson.decode(res)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template.render(&quot;view.html&quot;, context)</span><br></pre></td></tr></table></figure><p>模板</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;(header.html)&#125;  </span><br><span class="line">   &lt;body&gt;  </span><br><span class="line">      &#123;# 不转义变量输出 #&#125;  </span><br><span class="line">      姓名：&#123;* string.upper(name) *&#125;&lt;br/&gt;  </span><br><span class="line">      &#123;# 转义变量输出 #&#125;  </span><br><span class="line"></span><br><span class="line">      年龄: &#123;* age + 10 *&#125;&lt;br/&gt;  </span><br><span class="line">      &#123;# 循环输出 #&#125;  </span><br><span class="line">      爱好：  </span><br><span class="line">      &#123;% for i, v in ipairs(hobby) do %&#125;  </span><br><span class="line">         &#123;% if v == &#x27;电影&#x27; then  %&#125; - xxoo</span><br><span class="line">            </span><br><span class="line">              &#123;%else%&#125;  - &#123;* v *&#125; </span><br><span class="line">&#123;% end %&#125;  </span><br><span class="line">         </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">  </span><br><span class="line">      成绩：  </span><br><span class="line">      &#123;% local i = 1; %&#125;  </span><br><span class="line">      &#123;% for k, v in pairs(score) do %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">         &#123;* k *&#125; = &#123;* v *&#125;  </span><br><span class="line">         &#123;% i = i + 1 %&#125;  </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">      成绩2：  </span><br><span class="line">      &#123;% for i = 1, #score2 do local t = score2[i] %&#125;  </span><br><span class="line">         &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">          &#123;* t.name *&#125; = &#123;* t.score *&#125;  </span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line">      &#123;# 中间内容不解析 #&#125;  </span><br><span class="line">      &#123;-raw-&#125;&#123;(file)&#125;&#123;-raw-&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">掌门：</span><br><span class="line">&#123;* zhangmen *&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#123;% for i = 1, #zhangmen do local z = zhangmen[i] %&#125;  </span><br><span class="line">         &#123;* z.deptId *&#125;,&#123;* z.age *&#125;,&#123;* z.name *&#125;,&#123;* z.empno *&#125;,&lt;br&gt;</span><br><span class="line">      &#123;% end %&#125;&lt;br/&gt;  </span><br><span class="line"></span><br><span class="line">&#123;(footer.html)&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Lua-开源项目"><a href="#Lua-开源项目" class="headerlink" title="Lua 开源项目"></a>Lua 开源项目</h2><h3 id="WAF"><a href="#WAF" class="headerlink" title="WAF"></a>WAF</h3><p><a target="_blank" rel="noopener" href="https://github.com/unixhot/waf">https://github.com/unixhot/waf</a></p><p><a target="_blank" rel="noopener" href="https://github.com/loveshell/ngx_lua_waf">https://github.com/loveshell/ngx_lua_waf</a></p><p>l 防止 SQL 注入，本地包含，部分溢出，fuzzing 测试，XSS&#x2F;SSRF 等 Web 攻击</p><p>l 防止 Apache Bench 之类压力测试工具的攻击</p><p>l 屏蔽常见的扫描黑客工具，扫描器</p><p>l 屏蔽图片附件类目录执行权限、防止 webshell 上传</p><p>l 支持 IP 白名单和黑名单功能，直接将黑名单的 IP 访问拒绝</p><p>l 支持 URL 白名单，将不需要过滤的 URL 进行定义</p><p>l 支持 User-Agent 的过滤、支持 CC 攻击防护、限制单个 URL 指定时间的访问次数</p><p>l 支持支持 Cookie 过滤，URL 与 URL 参数过滤</p><p>l 支持日志记录，将所有拒绝的操作，记录到日志中去</p><h3 id="Kong-基于Openresty的流量网关"><a href="#Kong-基于Openresty的流量网关" class="headerlink" title="Kong 基于Openresty的流量网关"></a>Kong 基于Openresty的流量网关</h3><p><a target="_blank" rel="noopener" href="https://konghq.com/">https://konghq.com/</a></p><p><a target="_blank" rel="noopener" href="https://github.com/kong/kong">https://github.com/kong/kong</a></p><p>Kong 基于 OpenResty，是一个云原生、快速、可扩展、分布式的微服务抽象层（Microservice Abstraction Layer），也叫 API 网关（API Gateway），在 Service Mesh 里也叫 API 中间件（API Middleware）。</p><p>Kong 开源于 2015 年，核心价值在于高性能和扩展性。从全球 5000 强的组织统计数据来看，Kong 是现在依然在维护的，在生产环境使用最广泛的 API 网关。</p><p>Kong 宣称自己是世界上最流行的开源微服务 API 网关（The World’s Most Popular Open Source Microservice API Gateway）。</p><p>核心优势：</p><p>l 可扩展：可以方便的通过添加节点水平扩展，这意味着可以在很低的延迟下支持很大的系统负载。</p><p>l 模块化：可以通过添加新的插件来扩展 Kong 的能力，这些插件可以通过 RESTful Admin API 来安装和配置。</p><p>l 在任何基础架构上运行：Kong 可以在任何地方都能运行，比如在云或混合环境中部署 Kong，单个或全球的数据中心。</p><h3 id="APISIX"><a href="#APISIX" class="headerlink" title="APISIX"></a>APISIX</h3><h3 id="ABTestingGateway"><a href="#ABTestingGateway" class="headerlink" title="ABTestingGateway"></a>ABTestingGateway</h3><p><a target="_blank" rel="noopener" href="https://github.com/CNSRE/ABTestingGateway">https://github.com/CNSRE/ABTestingGateway</a></p><p>ABTestingGateway 是一个可以动态设置分流策略的网关，关注与灰度发布相关领域，基于 Nginx 和 ngx-lua 开发，使用 Redis 作为分流策略数据库，可以实现动态调度功能。</p><p>ABTestingGateway 是新浪微博内部的动态路由系统 dygateway 的一部分，目前已经开源。在以往的基于 Nginx 实现的灰度系统中，分流逻辑往往通过 rewrite 阶段的 if 和 rewrite 指令等实现，优点是性能较高，缺点是功能受限、容易出错，以及转发规则固定，只能静态分流。ABTestingGateway 则采用 ngx-lua，通过启用 lua-shared-dict 和 lua-resty-lock 作为系统缓存和缓存锁，系统获得了较为接近原生 Nginx 转发的性能。</p><p>l 支持多种分流方式，目前包括 iprange、uidrange、uid 尾数和指定uid分流</p><p>l 支持多级分流，动态设置分流策略，即时生效，无需重启</p><p>l 可扩展性，提供了开发框架，开发者可以灵活添加新的分流方式，实现二次开发</p><p>l 高性能，压测数据接近原生 Nginx 转发</p><p>l 灰度系统配置写在 Nginx 配置文件中，方便管理员配置</p><p>l 适用于多种场景：灰度发布、AB 测试和负载均衡等</p></div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post_share"><div class="social-share" data-image="/img/cover_default_img/06.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wechat.webp" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/alipay.webp" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/MySQL(1)%E5%9F%BA%E7%A1%80%E7%AF%87/" title="MySQL(1)基础篇"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/05.webp" onerror='onerror=null,src="/img/404.webp"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL(1)基础篇</div></div></a></div><div class="next-post pull-right"><a href="/blog/Nginx%E5%9F%BA%E7%A1%80/" title="Nginx基础篇笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/05.webp" onerror='onerror=null,src="/img/404.webp"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nginx基础篇笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/Nginx%E5%9F%BA%E7%A1%80/" title="Nginx基础篇笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/05.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-01</div><div class="title">Nginx基础篇笔记</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">spongehah</div><div class="author-info__description">Java后端学习中，我的原创日常笔记将会分享在这里，还会转载一些觉得写的好的笔记，快来和我一起学习吧！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="http://47.115.207.49/"><i class="fas fa-home"></i><span>The another blog</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/spongehah" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="/spongehah@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#4a7dbe"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到HahHome！<br>本站运行时间为本站搭建完成时间，站主第一个博客网站搭建时间为2022年11月25日<br>站主方向为Java后端，平时记录一些自己的学习笔记，也会转载一些觉得写的好的博客，站主会抽空定期更新的~~<br>更多笔记和资料没有md文档无法上传，另外想获得实时笔记和md源文档还有更多资料可以关注一下我的github仓库。<font color="red">💘</font></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%AB%98%E7%BA%A7-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E6%89%A9%E5%AE%B9"><span class="toc-number">1.</span> <span class="toc-text">Nginx高级 第一部分：扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8D%95%E6%9C%BA%E5%9E%82%E7%9B%B4%E6%89%A9%E5%AE%B9%EF%BC%9A%E7%A1%AC%E4%BB%B6%E8%B5%84%E6%BA%90%E5%A2%9E%E5%8A%A0"><span class="toc-number">1.1.</span> <span class="toc-text">1.单机垂直扩容：硬件资源增加</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%EF%BC%9A%E9%9B%86%E7%BE%A4%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">2.水平扩展：集群化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E8%B0%83%E4%BC%98"><span class="toc-number">1.3.</span> <span class="toc-text">基本调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86-%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.1.</span> <span class="toc-text">会话管理-修改负载均衡策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E9%AB%98%E7%BA%A7%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">Nginx高级负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8sticky%E6%A8%A1%E5%9D%97%E5%AE%8C%E6%88%90%E5%AF%B9Nginx%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">使用sticky模块完成对Nginx的负载均衡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeepAlive"><span class="toc-number">1.3.2.</span> <span class="toc-text">KeepAlive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E5%92%8C%E4%B8%8D%E7%94%A8%EF%BC%9F"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">什么时候用和不用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8keepalive"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">&#x3D;&#x3D;对客户端使用keepalive&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%B8%8A%E6%B8%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8keepalive"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">&#x3D;&#x3D;对上游服务器使用keepalive&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KeepAlive%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">KeepAlive配置总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KeepAlive%E5%8E%8B%E6%B5%8B%EF%BC%9AAB%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">KeepAlive压测：AB安装使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UpStream-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8A%E6%B8%B8%E9%9B%86%E7%BE%A4-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">UpStream(反向代理上游集群)工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E9%99%90%E5%88%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">&#x3D;&#x3D;对客户端的限制配置&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#header%E5%92%8C%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">&#x3D;&#x3D;header和连接配置&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">&#x3D;&#x3D;缓冲区配置&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UpStream%E9%85%8D%E7%BD%AE%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">UpStream配置总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9EIP"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">获取客户端真实IP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gzip"><span class="toc-number">1.3.4.</span> <span class="toc-text">Gzip</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gzip%E5%8A%A8%E6%80%81%E5%8E%8B%E7%BC%A9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">Gzip动态压缩配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gzip%E9%9D%99%E6%80%81%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">Gzip静态压缩</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Brotli%EF%BC%88Br%EF%BC%89"><span class="toc-number">1.3.5.</span> <span class="toc-text">Brotli（Br）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%AD%E7%9A%84%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.6.</span> <span class="toc-text">反向代理中的容错机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">参考文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">重试机制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E8%B0%83%E4%BC%98"><span class="toc-number">1.4.</span> <span class="toc-text">并发调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Concat%E5%90%88%E5%B9%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82"><span class="toc-number">1.4.1.</span> <span class="toc-text">Concat合并客户端请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">1.4.2.</span> <span class="toc-text">资源静态化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSI%E5%90%88%E5%B9%B6nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.3.</span> <span class="toc-text">SSI合并nginx服务器端文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">配置文件配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSI%E5%91%BD%E4%BB%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">SSI命令配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rsync"><span class="toc-number">1.4.4.</span> <span class="toc-text">rsync</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync%E6%89%8B%E5%8A%A8%E6%8B%89%E5%8F%96%E5%90%8C%E6%AD%A5%E6%BA%90%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">rsync手动拉取同步源文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%85%8D%E5%AF%86"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">增加安全认证及免密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">源服务器推送文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inotify%E7%9B%91%E6%8E%A7%E8%87%AA%E5%8A%A8%E6%8E%A8%E9%80%81"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">inotify监控自动推送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.4.5.</span> <span class="toc-text">常用参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.1.</span> <span class="toc-text">浏览器缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">强制缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">协商缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GEOip"><span class="toc-number">1.5.2.</span> <span class="toc-text">GEOip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.3.</span> <span class="toc-text">正向代理配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86proxy%E7%BC%93%E5%AD%98"><span class="toc-number">1.5.4.</span> <span class="toc-text">反向代理proxy缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">最小配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%B8%85%E7%90%86"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">缓存清理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E7%BC%93%E5%AD%98range"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">断点续传缓存range</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">详细配置</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86-%E9%AB%98%E6%95%88"><span class="toc-number">2.</span> <span class="toc-text">第二部分 高效</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">2.1.</span> <span class="toc-text">Nginx内存缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%A4%96%E7%BD%AE%E7%BC%93%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.</span> <span class="toc-text">Nginx外置缓存缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#error-page"><span class="toc-number">2.2.1.</span> <span class="toc-text">error_page</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BF%E5%90%8Dlocation"><span class="toc-number">2.2.2.</span> <span class="toc-text">匿名location</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-memcached"><span class="toc-number">2.2.3.</span> <span class="toc-text">nginx + memcached</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-redis"><span class="toc-number">2.2.4.</span> <span class="toc-text">nginx + redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stream%E6%A8%A1%E5%9D%97%E4%B8%BAnginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86mysql"><span class="toc-number">2.3.</span> <span class="toc-text">Stream模块为nginx反向代理mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81"><span class="toc-number">2.4.</span> <span class="toc-text">限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">2.5.</span> <span class="toc-text">日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#access-log%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.1.</span> <span class="toc-text">access.log配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#errorlog%E5%92%8C%E6%97%A5%E5%BF%97%E5%88%86%E5%89%B2"><span class="toc-number">2.5.2.</span> <span class="toc-text">errorlog和日志分割</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">2.6.</span> <span class="toc-text">健康检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream%E8%A2%AB%E5%8A%A8%E5%BC%8F%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.6.1.</span> <span class="toc-text">upstream被动式重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%8A%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">2.6.2.</span> <span class="toc-text">主动健康检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">2.7.</span> <span class="toc-text">Lua基础语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Openresty-Nginx-Lua"><span class="toc-number">2.8.</span> <span class="toc-text">Openresty Nginx + Lua</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="toc-number">2.8.1.</span> <span class="toc-text">安装启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-nginx-module"><span class="toc-number">2.8.2.</span> <span class="toc-text">lua-nginx-module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5lua%E7%8E%AF%E5%A2%83"><span class="toc-number">2.8.2.1.</span> <span class="toc-text">引入lua环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8lua%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96%E5%90%84%E5%80%BC"><span class="toc-number">2.8.2.2.</span> <span class="toc-text">用lua代码获取各值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98"><span class="toc-number">2.8.3.</span> <span class="toc-text">Nginx缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E5%85%A8%E5%B1%80%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">2.8.3.1.</span> <span class="toc-text">Nginx全局内存缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-resty-lrucache"><span class="toc-number">2.8.3.2.</span> <span class="toc-text">lua-resty-lrucache</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-resty-redis%E8%AE%BF%E9%97%AEredis"><span class="toc-number">2.8.4.</span> <span class="toc-text">lua-resty-redis访问redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis2-nginx-module"><span class="toc-number">2.8.5.</span> <span class="toc-text">redis2-nginx-module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-resty-mysql"><span class="toc-number">2.8.6.</span> <span class="toc-text">lua-resty-mysql</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%AE%9E%E6%97%B6%E6%B8%B2%E6%9F%93-lua-resty-template"><span class="toc-number">2.9.</span> <span class="toc-text">模板实时渲染 lua-resty-template</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%92%8C%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95"><span class="toc-number">2.9.1.</span> <span class="toc-text">准备和简单测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE"><span class="toc-number">2.9.2.</span> <span class="toc-text">其他测试配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.9.3.</span> <span class="toc-text">完整配置示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#layout-%E5%B8%83%E5%B1%80%E7%BB%9F%E4%B8%80%E9%A3%8E%E6%A0%BC"><span class="toc-number">2.9.4.</span> <span class="toc-text">layout 布局统一风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E7%BC%93%E5%AD%98-mysql-%E6%A8%A1%E6%9D%BF%E8%BE%93%E5%87%BA"><span class="toc-number">2.9.5.</span> <span class="toc-text">Redis缓存+mysql+模板输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.10.</span> <span class="toc-text">Lua 开源项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WAF"><span class="toc-number">2.10.1.</span> <span class="toc-text">WAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kong-%E5%9F%BA%E4%BA%8EOpenresty%E7%9A%84%E6%B5%81%E9%87%8F%E7%BD%91%E5%85%B3"><span class="toc-number">2.10.2.</span> <span class="toc-text">Kong 基于Openresty的流量网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APISIX"><span class="toc-number">2.10.3.</span> <span class="toc-text">APISIX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ABTestingGateway"><span class="toc-number">2.10.4.</span> <span class="toc-text">ABTestingGateway</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/Kafka%E7%AC%94%E8%AE%B0/" title="Kafka笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/03.webp" onerror='this.onerror=null,this.src="/img/404.webp"' alt="Kafka笔记"></a><div class="content"><a class="title" href="/blog/Kafka%E7%AC%94%E8%AE%B0/" title="Kafka笔记">Kafka笔记</a><time datetime="2023-10-11T15:56:32.000Z" title="发表于 2023-10-11 23:56:32">2023-10-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/Redis/" title="Redis安装和常见数据类型命令"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/03.webp" onerror='this.onerror=null,this.src="/img/404.webp"' alt="Redis安装和常见数据类型命令"></a><div class="content"><a class="title" href="/blog/Redis/" title="Redis安装和常见数据类型命令">Redis安装和常见数据类型命令</a><time datetime="2023-10-01T06:51:00.000Z" title="发表于 2023-10-01 14:51:00">2023-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/MySQL(6)%E5%AE%9E%E6%88%9845%E8%AE%B2%E7%AC%94%E8%AE%B0/" title="MySQL(6)实战45讲笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/01.webp" onerror='this.onerror=null,this.src="/img/404.webp"' alt="MySQL(6)实战45讲笔记"></a><div class="content"><a class="title" href="/blog/MySQL(6)%E5%AE%9E%E6%88%9845%E8%AE%B2%E7%AC%94%E8%AE%B0/" title="MySQL(6)实战45讲笔记">MySQL(6)实战45讲笔记</a><time datetime="2023-10-01T06:50:06.000Z" title="发表于 2023-10-01 14:50:06">2023-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/MySQL(5)%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/" title="MySQL(5)日志与备份篇"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/06.webp" onerror='this.onerror=null,this.src="/img/404.webp"' alt="MySQL(5)日志与备份篇"></a><div class="content"><a class="title" href="/blog/MySQL(5)%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/" title="MySQL(5)日志与备份篇">MySQL(5)日志与备份篇</a><time datetime="2023-10-01T06:50:05.000Z" title="发表于 2023-10-01 14:50:05">2023-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/MySQL(4)%E4%BA%8B%E5%8A%A1%E7%AF%87/" title="MySQL(4)事务篇"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/cover_default_img/04.webp" onerror='this.onerror=null,this.src="/img/404.webp"' alt="MySQL(4)事务篇"></a><div class="content"><a class="title" href="/blog/MySQL(4)%E4%BA%8B%E5%8A%A1%E7%AF%87/" title="MySQL(4)事务篇">MySQL(4)事务篇</a><time datetime="2023-10-01T06:50:04.000Z" title="发表于 2023-10-01 14:50:04">2023-10-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/cover_default_img/06.webp)"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By spongehah</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp; <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="iconfont icon-baidu"></i><span>百度搜索</span></a><a class="rightMenu-item" href="#post-comment" onclick="rmf.yinyong()"><i class="fa-solid fa-message"></i><span>引用文本评论</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span>阅读模式</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('/pluginsSrc/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.hahhome.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.hahhome.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.textContent = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('/pluginsSrc/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '7ecf16f704fd5834a3a5',
      clientSecret: 'ed4a99d0eb3e4480a27445dd2b6a03b96fa99ddf',
      repo: 'hahhome.github.io',
      owner: 'spongehah',
      admin: ['spongehah'],
      id: 'd61047eaf2ef10938c6c371f09323e48',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    getCSS('/pluginsSrc/gitalk/dist/gitalk.css')
    getScript('/pluginsSrc/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.textContent= n
  }
}

if ('Twikoo' === 'Gitalk' || !true) {
  if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script async src="https://npm.elemecdn.com/tzy-blog/lib/js/theme/cursor.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer data-pjax src="/js/cat.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="/pluginsSrc/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="/pluginsSrc/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script id="click-heart" src="/pluginsSrc/butterfly-extsrc/dist/click-heart.min.js" async mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var e=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock_anzhiyu"),e&&e.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="b16a1fa0e63c46a4b8f28abfb06ae3fe",gaud_map_key="e2b04289e870b005374ee030148d64fd&s=rsv3",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:300,hOffset:20,vOffset:-20},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>